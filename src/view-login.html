<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<!-- import style component -->
<link rel="import" href="style/flat-icons.html">
<link rel="import" href="style/flat-input.html">
<link rel="import" href="style/flat-checkbox.html">
<link rel="import" href="style/flat-button.html">
<dom-module id="view-login">
  <template>
    <style include="flat-button flat-input flat-checkbox">
       :host {
        display: block;
        --paper-checkbox-checked-color: #202020;
      }

      h1,
      h2 {
        margin: 0;
        font-weight: 400;
      }

      section {
        height: 100vh;
        width: 100%;
      }

      article {
        padding: 0 100px;
      }

      .container {
        display: flex;
        justify-content: center;
        align-content: center;
      }

      .flex-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .left-half {
        background-image: linear-gradient(rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0.65)), url("/images/cover/welcome.jpg");
        background-repeat: no-repeat;
        background-position: center top;
        background-size: cover;
        background-color: #202020;
        flex: 1;
        padding: 1rem;
        margin: 0;
      }

      .right-half {
        background-color: #ffffff;
        flex: 1;
        padding: 1rem;
      }

      .main-title {
        font-size: 3.5rem;
        font-weight: 400;
        text-align: center;
      }

      .main-describe {
        font-size: 1.5rem;
        font-weight: 300;
        text-align: center;
      }

      .form-title {
        text-align: center;
      }

      .form-title>h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }

      .white {
        color: #ffffff;
      }

      .login-btn,
      .register-btn,
      .reset-btn,
      .login-form,
      .reset-form,
      .register-form {
        width: 100%;
        margin: 10px auto;
      }

      .link>a {
        color: #0070c9;
        margin-top: .78571em;
        margin-bottom: -.21429em;
        display: block;
        text-decoration: none;
      }

      .link>a:hover {
        color: #0070c9;
      }

      .link>a:before,
      .link>a:after {
        padding-left: .3em;
        top: 0;
      }

      .logo {
        display: none;
        margin: 0 auto;
        padding: 0;
        width: 150px;
        height: 150px;
      }

      .mobile-title {
        display: none;
      }

      .keep-session-checkbox {
        margin: 10px 0;
        height: 20px;
        @apply --layout-horizontal;
      }

      .keep-session-checkbox>label {
        margin-left: 10px;
      }

      #toastAlert {
        --paper-toast-background-color: #e53935;
        --paper-toast-color: #FFFFFF;
        opacity: 1;
        font-size: 1rem;
        width: 100%;
        padding: 16px;
      }

      #toastSuccess {
        --paper-toast-background-color: #43A047;
        --paper-toast-color: #FFFFFF;
        opacity: 1;
        font-size: 1rem;
        width: 100%;
        padding: 16px;
      }

      .toast-flex-container {
        display: -webkit-flex;
        display: flex;
        -webkit-align-self: stretch;
        align-self: stretch;
        justify-content: space-between;
        width: 100%;
        height: auto;
      }

      .toast-flex-item:first-child {
        align-self: stretch;
        margin-right: auto;
      }

      .toast-flex-item:last-child {
        align-self: flex-end;
        margin-top: 0;
      }

      .toast-flex-item {
        margin: auto 0;
      }

      .close-toast-button {
        text-transform: none;
        color: #FFFFFF;
        float: right;
      }

      @media (min-width: 320px) and (max-width: 1024px) {
        .left-half {
          display: none;
        }
        .logo {
          display: block;
        }
        article {
          padding: 0 30px;
        }
        button {
          font-size: 0.95rem;
        }
      }
    </style>
    <firebase-auth app-name="smart-mes" id="auth" user="{{user}}" signed-in="[[signedIn]]"></firebase-auth>
    <firebase-document app-name="smart-mes" id="user" path="/user/[[user.uid]]" data="[[k]]"></firebase-document>
    <firebase-query app-name="smart-mes" id="data" path="/data"></firebase-query>
    <app-localstorage-document key="keep-session" data="{{remember}}"></app-localstorage-document>
    <iron-ajax id="requestSampleData" url="../data/sample.json" handle-as="json" verbose="true" last-response="{{sampleData}}"></iron-ajax>
    <section class="container">
      <figure class="flex-item left-half">
        <article>
          <h1 title="IMES" class="main-title white">IMES</h1>
          <div title="Smart Industry Helper" class="main-describe white">Your Smart Industry Helper</div>
        </article>
      </figure>
      <div class="flex-item right-half">
        <article>
          <img class="logo" role="img" src="/images/logo/logo.svg" title="Logo" alt="application logo">
          <h1 title="IMES" class="main-title mobile-title">IMES</h1>
          <form hidden$="[[!login]]" autocomplete="on" class="login-form" on-submit="_login">
            <div class="form-title">
              <h2>User Login</h2>
            </div>
            <flat-input>
              <input type="email" id="accountEmail" name="Email" placeholder="Email" maxlength="40" auto-complete="email" autofocus required
                aria-labelledby="accountEmailLabel">
              <flat-md-decorator error-message="Invalid Email" aria-hidden="true">
                <label id="accountEmailLabel">Email</label>
                <flat-underline></flat-underline>
              </flat-md-decorator>
            </flat-input>
            <flat-input>
              <input type="password" id="accountPassword" name="Password" placeholder="Passwrod" maxlength="40" auto-complete="current-password"
                autofocus required aria-labelledby="accountPasswordLabel">
              <flat-md-decorator error-message="Invalid Input" aria-hidden="true">
                <label id="accountPasswordLabel">Password</label>
                <flat-underline></flat-underline>
              </flat-md-decorator>
            </flat-input>

            <div class="keep-session-checkbox">
              <flat-checkbox tabindex="0">
                <input type="checkbox" id="setKeepSession" name="setKeepSession" checked$="[[remember]]" on-change="_toggleKeepSession">
                <flat-md-decorator></flat-md-decorator aria-hidden="true">
              </flat-checkbox>
              <label for="setKeepSession">Keep me signed in</label>
            </div>
            <flat-button class="login-btn" role="button" on-click="_login"><button type="button">Log in</button></flat-button>
            <div class="link"><a href="javascript:void(0);" on-click="_showReset" class="login-forget">Forgot Password?</a></div>
            <div class="link"><a href="javascript:void(0);" on-click="_showRegister" class="login-register">Donâ€™t have an account? Get one here.</a></div>
          </form>


          <form hidden$="[[!register]]" autocomplete="on" class="register-form" on-submit="_register">
            <div class="form-title">
              <h2>User Register</h2>
            </div>
            <flat-input>
              <input type="email" id="register_email" name="Email" placeholder="Email" maxlength="40" auto-complete="email" required aria-labelledby="registerEmailLabel">
              <flat-md-decorator error-message="Invalid Email" aria-hidden="true">
                <label id="registerEmailLabel">Email</label>
                <flat-underline></flat-underline>
              </flat-md-decorator>
            </flat-input>
            <flat-input>
              <input type="password" id="register_passwd" name="Password" placeholder="New Password" maxlength="40" required aria-labelledby="registerPasswordLabel">
              <flat-md-decorator error-message="Invalid Input" aria-hidden="true">
                <label id="registerPasswordLabel">Password</label>
                <flat-underline></flat-underline>
              </flat-md-decorator>
            </flat-input>
            <flat-input>
              <input type="text" id="register_organization" name="Organization" placeholder="Organization" maxlength="40" required aria-labelledby="registerOrganizationLabel">
              <flat-md-decorator error-message="Invalid Input" aria-hidden="true">
                <label id="registerOrganizationLabel">Organization</label>
                <flat-underline></flat-underline>
              </flat-md-decorator>
            </flat-input>
            <flat-input>
              <input type="tel" id="register_phone" name="Phone" placeholder="Phone" maxlength="10" required aria-labelledby="registerPhoneLabel"
                pattern="\d{10}" onkeypress='return event.charCode >= 48 && event.charCode <= 57'>
              <flat-md-decorator error-message="Invalid Phone Number" aria-hidden="true">
                <label id="registerPhoneLabel">Phone</label>
                <flat-underline></flat-underline>
              </flat-md-decorator>
            </flat-input>
            <flat-button class="register-btn" role="button" on-click="_register">
              <button type="button">Send Confirmation</button>
            </flat-button>
            <div class="link"><a href="javascript:void(0);" on-click="_hideRegister" class="login-register">Already have account? Log in</a></div>
          </form>
          <form hidden$="[[!reset]]" class="reset-form" on-submit="_resetPassword">
            <div class="form-title">
              <h2>Reset Your Password</h2>
            </div>
            <flat-input>
              <input type="email" id="resetPassword" name="resetPassword" placeholder="Email" maxlength="40" auto-complete="email" required
                aria-labelledby="resetPasswordLabel">
              <flat-md-decorator error-message="Invalid Email" aria-hidden="true">
                <label id="resetPasswordLabel">Email</label>
                <flat-underline></flat-underline>
              </flat-md-decorator>
            </flat-input>
            <flat-button class="reset-btn" role="button" on-click="_resetPassword"><button type="button">Reset Password</button></flat-button>
            <div class="link"><a href="javascript:void(0);" rel="noopenner" on-click="_hideReset" class="login-forget">Have an account? Log in.</a></div>
          </form>
        </article>
      </div>
      <paper-toast id="toastSuccess" always-on-top vertical-align="bottom" class="fit-bottom" duration="5000">
        <div class="toast-flex-container">
          <div class="toast-flex-item">
            <p>[[successMessage]]</p>
          </div>
          <div class="toast-flex-item">
            <paper-icon-button on-tap="_closeToastSuccess" role="bottom" class="close-toast-button" icon="icons:close-big" tabindex="-1"></paper-icon-button>
          </div>
        </div>
      </paper-toast>
      <paper-toast id="toastAlert" always-on-top vertical-align="bottom" class="fit-bottom" duration="5000">
        <div class="toast-flex-container">
          <div class="toast-flex-item">
            <p>[[alertMessage]]</p>
          </div>
          <div class="toast-flex-item">
            <paper-icon-button on-tap="_closeToastAlert" role="bottom" class="close-toast-button" icon="icons:close-big" tabindex="-1"></paper-icon-button>
          </div>
        </div>
      </paper-toast>
      <iron-a11y-keys id="a11y" target="[[loginTarget]]" keys="enter" on-keys-pressed="_login"></iron-a11y-keys>
      <iron-a11y-keys id="a11y" target="[[resetTarget]]" keys="enter" on-keys-pressed="_resetPassword"></iron-a11y-keys>
    </section>
  </template>
  <script>
    class ViewLogin extends Polymer.Element {
      static get is() {
        return 'view-login'
      }

      static get properties() {
        return {
          login: {
            type: Boolean,
            value: true
          },
          reset: {
            type: Boolean,
            value: false
          },
          register: {
            type: Boolean,
            value: false
          },
          remember: {
            type: Boolean,
            value: false
          },
          loginTarget: {
            type: Object,
            value: () => {
              return this.accountPassword
            }
          },
          resetTarget: {
            type: Object,
            value: () => {
              return this.resetPassword
            }
          },
          user: Object,
          sampleData: Object,
          alertMessage: String,
          successMessage: String
        }
      }

      _login() {
        if (this.$.accountEmail.value && this.$.accountPassword.value) {
          this.$.auth.signInWithEmailAndPassword(this.$.accountEmail.value, this.$.accountPassword.value)
            .then((response) => {
              this.set('route.path', '/dashboard')
              this.page = '/dashboard'
            })
            .catch((error) => {
              this.showAlertToast(error.code)
            })
        } else {
          this.showAlertToast('Email or Password cannot leave blank')
        }
      }

      _register() {
        const email = this.$.register_email.value
        const organize = this.$.register_organization.value
        const phone = this.$.register_phone.value
        const password = this.$.register_passwd.value
        const username = 'Untitled'
        if (!this.sampleData) {
          const request = this.$.requestSampleData.generateRequest()
          request.completes.then((req) => {
            console.log(req.response);
            console.info('%cLoaded sample data status:' + req.status + " " + req.statusText, 'color:green;');
          }).catch((rejected) => {
            let req = rejected.request;
            let error = rejected.error;
            console.error("Error requesting data: " + error + " of request " + req);
          })
        }

        if (email && organize && phone && password && username && this.sampleData) {
          this.$.auth.createUserWithEmailAndPassword(email, password)
            .then((response) => {
              this.$.auth.signInWithEmailAndPassword(email, password)
                .then((response) => {
                  this.user.updateProfile({
                    displayName: username
                  })
                  this.sendEmailVeirify()
                  const keyid = this.$.data.ref.push().key
                  this.addProfileInfo(username, email, organize, phone, keyid)
                  this.$.data.ref.child(keyid).set(this.sampleData).catch(error => {
                    this.showAlertToast(error.code)
                  })
                  this.$.auth.signOut()
                  this._hideRegister()
                }).catch((error) => {
                  this.showAlertToast(error.code)
                })
            })
            .catch((error) => {
              this.showAlertToast(error.code)
            })
        } else {
          this.showAlertToast('Please fill in the form completely.')
        }
      }

      addProfileInfo(username, email, organize, phone, keyid) {
        this.$.user.ref.set({
          displayname: username,
          email: email,
          photoURL: null,
          phone: phone,
          organization: organize,
          role: 'admin',
          description: 'No description for this user',
          key: keyid
        })
          .catch(error => {
            this.showAlertToast(error.code)
          })
      }

      sendEmailVeirify() {
        this.$.auth.onAuthStateChanged(user => {
          if (!user.emailVerified) {
            this.user.sendEmailVerification()
            this.showSuccessToast("Register successful. We've sent verification code to your email")
          }
        });
      }

      _resetPassword() {
        let resetPassword = this.$.resetPassword.value
        if (resetPassword) {
          this.$.auth.sendPasswordresetPassword(resetPassword)
            .then((response) => {
              this.showSuccessToast('Reset password has been send to your email.')
            })
            .catch((error) => {
              this.showAlertToast(error.code)
            })
        } else {
          this.showAlertToast('Email cannot leave blank')
        }
      }

      _toggleKeepSession() {
        this.remember = !!this.$.setKeepSession.checked
      }

      _showReset() {
        this.reset = true
        this.login = false
      }

      _hideReset() {
        this.reset = false
        this.login = true
      }

      _showRegister() {
        this.register = true
        this.login = false
      }

      _hideRegister() {
        this.register = false
        this.login = true
      }

      showAlertToast(text) {
        this.alertMessage = text
        this.$.toastAlert.open()
      }

      showSuccessToast(text) {
        this.successMessage = text
        this.$.toastSuccess.open()
      }

      _closeToastAlert() {
        this.$.toastAlert.close()
      }

      _closeToastSuccess() {
        this.$.toastSuccess.close()
      }
    }
    window.customElements.define(ViewLogin.is, ViewLogin)
  </script>
</dom-module>