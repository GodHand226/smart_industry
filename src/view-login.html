<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="/bower_components/polymerfire/firebase-document.html">
<link rel="import" href="/bower_components/polymerfire/firebase-query.html">
<link rel="import" href="/bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="/bower_components/iron-selector/iron-selector.html">
<!-- import style component -->
<link rel="import" href="style/flat-icons.html">
<link rel="import" href="style/flat-input.html">

<dom-module id="view-login">
  <template>
    <style include="flat-input">
       :host {
        display: block;
        background-color: #ffffff;
      }

      h1,
      h2 {
        margin: 0;
        font-weight: 400;
      }

      section {
        height: 100vh;
        width: 100%;
      }

      article {
        width: 500px;
        margin: 0 auto;
      }

      .flex-container {
        display: flex;
        align-content: center;
        justify-content: space-between;
        flex-flow: row nowrap;
      }

      .flex-item {
        display: flex;
        flex-direction: column;
        justify-content: center;
        flex: 1;
        padding: 1rem;
      }

      .model-btn {
        margin: 0;
        width: 160px;
      }

      .form-title {
        text-align: center;
      }

      .form-title>h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }

      .login-btn,
      .register-btn,
      .reset-btn,
      .login-form,
      .reset-form,
      .register-form {
        width: 100%;
        margin: 10px auto;
      }

      paper-button {
        font-size: 1rem;
        font-weight: 500;
        height: 50px;
        color: #202020;
        border: 1px solid #202020;
      }

      paper-button:hover,
      paper-button.iron-selected {
        color: #ffffff;
        background-color: #202020;
      }

      p {
        margin: 10px 0;
      }

      .link>a {
        color: #0070c9;
        margin: 10px 0;
        display: block;
        text-decoration: none;
      }

      .link>a:hover {
        color: #0070c9;
      }

      .link>a:before,
      .link>a:after {
        padding-left: .3em;
        top: 0;
      }

      .logo {
        display: block;
        margin: 10px auto;
        width: 150px;
        height: 150px;
      }

      .keep-session-checkbox {
        margin: 10px 0;
        @apply --layout-horizontal;
      }

      #toastError {
        --paper-toast-background-color: #e53935;
      }

      #toastSuccess {
        --paper-toast-background-color: #43A047;
      }

      .toast {
        --paper-toast-color: #FFFFFF;
        font-size: 1rem;
        width: 100%;
        padding: 16px;
      }

      .toast-flex-container {
        display: -webkit-flex;
        display: flex;
        -webkit-align-self: stretch;
        align-self: stretch;
        justify-content: space-between;
        width: 100%;
        height: auto;
      }

      .toast-flex-item:first-child {
        align-self: stretch;
      }

      .toast-flex-item:last-child {
        align-self: flex-end;
      }

      .toast-flex-item {
        margin: auto 0;
      }

      .close-toast-button {
        text-transform: none;
        float: right;
      }

      @media (min-width: 320px) and (max-width: 767px) {
        .logo {
          display: block;
          margin: 12px auto;
        }
        .form-title>h2 {
          margin-bottom: 5px;
        }
        article {
          width: 90%;
        }
        button {
          font-size: 0.95rem;
        }
        flat-input {
          margin: 0;
        }
        p {
          margin: 5px 0;
        }
      }
    </style>
    <firebase-auth app-name="smart-mes" id="userAuth" user="{{user}}"></firebase-auth>
    <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]"></firebase-document>
    <firebase-query app-name="smart-mes" id="factoryData" path="/data"></firebase-query>
    <iron-ajax id="requestSampleData" url="/data/sample/sample-[[model]].json" handle-as="json" verbose="true" last-response="{{sampleData}}"></iron-ajax>
    <app-localstorage-document key="keep-session" data="{{remember}}"></app-localstorage-document>
    <section class="flex-container">
      <div class="flex-item">
        <article>
          <img class="logo" src="/images/logo/logo.svg" title="Logo" alt="app logo">
          <div hidden$="[[!loginForm]]" class="login-form">
            <div class="form-title">
              <h2>Log in</h2>
            </div>
            <flat-input>
              <input type="email" id="loginEmail" name="Email" placeholder="Email address" maxlength="30" auto-complete="email" autofocus
                required aria-labelledby="accountEmailLabel">
              <span class="flat-md-decorator" error-message="Invalid Email" aria-hidden="true">
                <label id="accountEmailLabel">Email address</label>
                <span class="flat-underline"></span>
              </span>
            </flat-input>
            <flat-input>
              <input type="password" id="loginPassword" name="Password" placeholder="Password" maxlength="30" auto-complete="current-password"
                autofocus required aria-labelledby="accountPasswordLabel" autocomplete="off">
              <span class="flat-md-decorator" error-message="Invalid Input" aria-hidden="true">
                <label id="accountPasswordLabel">Password</label>
                <span class="flat-underline"></span>
              </span>
            </flat-input>
            <div class="keep-session-checkbox">
              <paper-checkbox id="keepSession" checked$="[[remember]]" on-change="toggleKeepSession" noink>Keep me signed in</paper-checkbox>
            </div>
            <paper-button class="login-btn" on-tap="login" title="Login" noink>Log in</paper-button>

            <div class="link">
              <a href="javascript:void(0);" on-click="showReset">Forgot?</a>
            </div>
            <div class="link">
              <a href="javascript:void(0);" on-click="showRegister">Don’t have an account? Sign up now.</a>
            </div>
          </div>

          <div hidden$="[[!registerForm]]" class="register-form">
            <div class="form-title">
              <h2>Register</h2>
            </div>
            <flat-input>
              <input type="email" id="register_email" name="Email" placeholder="Email address" maxlength="30" auto-complete="email" required
                aria-labelledby="registerEmailLabel">
              <span class="flat-md-decorator" error-message="Invalid Email" aria-hidden="true">
                <label id="registerEmailLabel">Email address</label>
                <span class="flat-underline"></span>
              </span>
            </flat-input>
            <flat-input>
              <input type="password" id="register_passwd" name="Password" placeholder="New password" maxlength="30" required aria-labelledby="registerPasswordLabel"
                autocomplete="off">
              <span class="flat-md-decorator" error-message="Invalid Input" aria-hidden="true">
                <label id="registerPasswordLabel">New password</label>
                <span class="flat-underline"></span>
              </span>
            </flat-input>
            <flat-input>
              <input type="text" id="register_organization" name="Organization" placeholder="Organization" maxlength="30" required aria-labelledby="registerOrganizationLabel">
              <span class="flat-md-decorator" error-message="Invalid Input" aria-hidden="true">
                <label id="registerOrganizationLabel">Organization</label>
                <span class="flat-underline"></span>
              </span>
            </flat-input>
            <flat-input>
              <input type="tel" id="register_phone" name="Phone" placeholder="Phone" maxlength="10" required aria-labelledby="registerPhoneLabel"
                pattern="\d{10}" onkeypress='return event.charCode >= 48 && event.charCode <= 57'>
              <span class="flat-md-decorator" error-message="Invalid Phone Number" aria-hidden="true">
                <label id="registerPhoneLabel">Phone</label>
                <span class="flat-underline"></span>
              </span>
            </flat-input>
            <p>Select Your Production Model</p>

            <iron-selector selected="{{model}}" attr-for-selected="name" fallback-selection="1" class="flex-container" role="navigation">
              <paper-button name="parallel" class="model-btn">
                Parallel
              </paper-button>
              <paper-button name="serial" class="model-btn">
                Serial
              </paper-button>
              <paper-button name="multi" class="model-btn">
                Multi
              </paper-button>
            </iron-selector>

            <div class="link">
              <p>By signing up you agree to IMES’s
                <a href="/term" target="_self" id="termOfService">Terms of Service</a>
            </div>
            </p>
            <paper-button class="register-btn" on-tap="register" title="Register and Login" noink>Register and Login</paper-button>
            <div class="link">
              <a href="javascript:void(0);" on-click="hideRegister">Already have account? Log in</a>
            </div>
          </div>

          <div hidden$="[[!resetForm]]" class="reset-form">
            <div class="form-title">
              <h2>Reset your password</h2>
              <p>Enter the email you used to signup with and we'll send you a link to reset your password.</p>
            </div>
            <flat-input>
              <input type="email" id="resetPassword" name="resetPassword" placeholder="Email address" maxlength="30" auto-complete="email"
                required aria-labelledby="resetPasswordLabel">
              <span class="flat-md-decorator" error-message="Invalid Email" aria-hidden="true">
                <label id="resetPasswordLabel">Email address</label>
                <span class="flat-underline"></span>
              </span>
            </flat-input>
            <paper-button class="reset-btn" on-tap="resetPassword" title="Reset password" noink>Reset Password</paper-button>
            <div class="link">
              <a href="javascript:void(0);" rel="noopenner" on-click="hideReset">Return to login</a>
            </div>
          </div>
        </article>
      </div>
      <paper-toast id="toastSuccess" always-on-top vertical-align="bottom" class="toast fit-bottom" duration="5000">
        <div class="toast-flex-container">
          <div class="toast-flex-item">
            <p>[[successMessage]]</p>
          </div>
          <div class="toast-flex-item">
            <paper-icon-button on-tap="_closeToastSuccess" class="close-toast-button" icon="icons:close-big" tabindex="-1" noink></paper-icon-button>
          </div>
        </div>
      </paper-toast>
      <paper-toast id="toastError" always-on-top vertical-align="bottom" class="toast fit-bottom" duration="5000">
        <div class="toast-flex-container">
          <div class="toast-flex-item">
            <p>[[errorMessage]]</p>
          </div>
          <div class="toast-flex-item">
            <paper-icon-button on-tap="_closetoastError" class="close-toast-button" icon="icons:close-big" tabindex="-1" noink></paper-icon-button>
          </div>
        </div>
      </paper-toast>
    </section>
  </template>
  <script>
    /**
     * @ViewLogins
     * @polymer 
     * @extends {Polymer.Element}
     */
    class ViewLogin extends Polymer.Element {
      static get is() {
        return 'view-login'
      }

      static get properties() {
        return {
          route: {
            type: Object,
            notify: true
          },
          loginForm: {
            type: Boolean,
            value: true
          },
          resetForm: {
            type: Boolean,
            value: false
          },
          registerForm: {
            type: Boolean,
            value: false
          },
          model: {
            type: String,
            value: 'parallel'
          },
          remember: {
            type: Boolean,
            value: true
          },
          sampleData: Object,
          errorMessage: String,
          successMessage: String
        }
      }
      constructor() {
        super()
      }

      connectedCallback() {
        super.connectedCallback()
        requestAnimationFrame(this._installListeners.bind(this))
      }

      _installListeners() {
        this.$.loginPassword.addEventListener('keyup', (e) => this._onEnterTrigger(e, 0))
        this.$.resetPassword.addEventListener('keyup', (e) => this._onEnterTrigger(e, 1))
        this.$.termOfService.addEventListener('click', (e) => this._goToTermOfService(e))
      }

      _onEnterTrigger(e, type) {
        if (e.key !== "Enter") return;
        if (type === 0) {
          this.login();
        } else if (type === 1) {
          this.resetPassword();
        }
        event.preventDefault(); // No need to `return false;`.
      }

      _goToTermOfService(e) {
        this.set('route.path', '/term')
      }

      login() {
        if (this.$.loginEmail.value && this.$.loginPassword.value) {
          this.$.userAuth.signInWithEmailAndPassword(this.$.loginEmail.value, this.$.loginPassword.value)
            .then((response) => {
              this.set('route.path', '/dashboard')
            })
            .catch((error) => {
              this._showErrorToast(error.code)
            })
        } else {
          this._showErrorToast('Email or Password cannot leave blank')
        }
      }

      register() {
        const email = this.$.register_email.value
        const organize = this.$.register_organization.value
        const phone = this.$.register_phone.value
        const password = this.$.register_passwd.value
        const username = 'Untitled'
        const timestamp = Math.round(Date.now() / 1000.0);
        if (!this.sampleData) {
          const request = this.$.requestSampleData.generateRequest()
          request.completes.then((req) => {
            //console.log(req.response);
            console.info('%cLoaded sample data status:' + req.status + " " + req.statusText, 'color:green;');
          }).catch((rejected) => {
            let req = rejected.request;
            let error = rejected.error;
            console.error("Error requesting data: " + error + " of request " + req);
          })
        }

        if (email && organize && phone && password && username && timestamp && this.sampleData) {
          this.$.userAuth.createUserWithEmailAndPassword(email, password)
            .then((response) => {
              this.$.userAuth.signInWithEmailAndPassword(email, password)
                .then((response) => {
                  this.user.updateProfile({
                    displayName: username,
                    phoneNumber: phone
                  })
                  this.user.sendEmailVerification()
                  this._showSuccessToast(
                    "Register successful. We've sent a confirmation link to your email you must follow in order to activate your account."
                  )
                  const keyid = this.$.factoryData.ref.push().key
                  this._addProfileInfo(username, email, organize, phone, keyid, timestamp)
                  this.$.factoryData.ref.child(keyid).set(this.sampleData).catch(error => {
                    console.error(error)
                    this._showErrorToast(error.code)
                  })
                }).catch((error) => {
                  console.error(error)
                  this._showErrorToast(error.code)
                })
            })
            .catch((error) => {
              console.error(error)
              this._showErrorToast(error.code)
            })
        } else {
          this._showErrorToast('Please fill in the form completely.')
        }
      }

      _addProfileInfo(username, email, organize, phone, keyid, timestamp) {
        this.$.userData.ref.set({
            displayname: username,
            email: email,
            photoURL: null,
            phone: phone,
            organization: organize,
            role: 'admin',
            description: 'No description for this user',
            key: keyid,
            created: timestamp
          })
          .catch(error => {
            this._showErrorToast(error.code)
          })
      }

      resetPassword() {
        let resetPassword = this.$.resetPassword.value
        if (resetPassword) {
          this.$.userAuth.sendPasswordResetEmail(resetPassword)
            .then((response) => {
              this._showSuccessToast('Reset password link has been send to your email.')
              this.$.resetPassword.value = "";
            })
            .catch((error) => {
              this._showErrorToast(error.code)
            })
        } else {
          this._showErrorToast('Email cannot leave blank')
        }
      }

      toggleKeepSession() {
        this.remember = !!this.$.keepSession.checked
      }

      showReset() {
        this.resetForm = true
        this.loginForm = false
      }

      hideReset() {
        this.resetForm = false
        this.loginForm = true
      }

      showRegister() {
        this.registerForm = true
        this.loginForm = false
      }

      hideRegister() {
        this.registerForm = false
        this.loginForm = true
      }

      _showErrorToast(text) {
        this.errorMessage = text
        this.$.toastError.open()
      }

      _showSuccessToast(text) {
        this.successMessage = text
        this.$.toastSuccess.open()
      }

      _closetoastError() {
        this.$.toastError.close()
      }

      _closeToastSuccess() {
        this.$.toastSuccess.close()
      }
    }
    window.customElements.define(ViewLogin.is, ViewLogin)
  </script>
</dom-module>