<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-bind.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/vaadin-material-theme/vaadin-text-field.html">
<link rel="import" href="/bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="/bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="/bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="/bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<!-- import style component -->
<link rel="import" href="style/flat-button.html">
<link rel="import" href="style/shared-styles.html">
<link rel="import" href="view-app.html">
<dom-module id="view-settings">
  <template>
    <style include="shared-styles app-grid-style flat-button">
       :host {
        display: block;
        padding: 10px;
        --app-grid-columns: 3;
        --app-grid-item-height: 50%;
      }

      .btn input[type=file] {
        font-size: 100px;
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
      }

      .card {
        min-height: 440px;
      }

      .upload-bar {
        width: 100%;
        height: 10px;
      }

      .switch {
        padding: 10px 0;
      }

      @media (min-width: 360px) and (max-width: 768px) {
         :host {
          --app-grid-columns: 1;
        }
      }

      @media (min-width: 769px) and (max-width: 1024px) {
         :host {
          --app-grid-columns: 2;
        }
      }

      @media (min-width: 1025px) and (max-width: 1200px) {
         :host {
          --app-grid-columns: 2;
        }
      }

      @media (min-width: 1201px) and (max-width: 2560px) {
         :host {
          --app-grid-columns: 3;
        }
      }
    </style>
    <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
    <firebase-messaging app-name="smart-mes" id="messaging" active="{{active}}" status-known="{{statusKnown}}" push-supported="{{pushSupported}}"
      on-message="handleMessage" token="{{token}}"></firebase-messaging>
    <firebase-document app-name="smart-mes" id="appData" path="/data/[[usr.key]]" data="{{appdata}}"></firebase-document>
    <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]" data="{{usr}}"></firebase-document>
    <firebase-document app-name="smart-mes" id="userToken" path="/user/[[user.uid]]/token" data="[[token]]"></firebase-document>
    <firebase-document app-name="smart-mes" id="appNotification" path="/data/[[usr.key]]/appData/notification" data="[[notification]]"></firebase-document>
    <firebase-document app-name="smart-mes" id="appEmailAlert" path="/data/[[usr.key]]/appData/email_alert" data="[[emailalert]]"></firebase-document>
    <firebase-document app-name="smart-mes" id="appBackup" path="/data/[[usr.key]]/appData/auto_backup" data="[[autobackup]]"></firebase-document>
    <app-localstorage-document key="app-lang" data="{{language}}"></app-localstorage-document>
    <app-localstorage-document key="notification" data="{{notification}}"></app-localstorage-document>
    <iron-ajax url="../data/languages.json" auto handle-as="json" last-response="{{languageItems}}"></iron-ajax>
    <ul class="app-grid">
      <li>
        <div class="card">
          <h1 class="title">{{localize('general-settings')}}</h1>
          <vaadin-combo-box label="{{localize('display-language')}}" id="languageSelector" items="[[languageItems]]" name="language selector"
            item-label-path="name" item-value-path="value" value="[[language]]" on-change="changeLanguage" error-message="Invalid input"
            loading="[[!languageItems]]" required always-float-label></vaadin-combo-box>

          <flat-button on-tap="scanDevice" class="btn" title="Search sensor">
            <button>Search Sensor</button>
          </flat-button>
          <flat-button on-tap="showDevice" class="btn" title="Show sensor">
            <button>Show Sensor</button>
          </flat-button>
          <flat-button on-tap="editDashboard" class="btn" title="Edit Dashboard">
            <button>Customize Dashboard</button>
          </flat-button>
        </div>
      </li>
      <li>
        <div class="card">
          <h1 class="title">{{localize('account-settings')}}</h1>
          <paper-input label="{{localize('display-name')}}" id="displayName" value="[[user.displayName]]" type="text" always-float-label></paper-input>
          <!-- <paper-progress value="0" min="0" max="100" class="upload-bar" id="uploadProgress"></paper-progress> -->
          <flat-button on-tap="openBrowseImageFile" class="btn" title="{{localize('remove-profile-image')}}">
            <button>Upload Profile Image</button>
            <input type="file" accept="image/*" name="file" id="uploadImageFile" on-change="_verifyUploadFile" class="inputfile" />
          </flat-button>
          <flat-button on-tap="deleteProfileImage" class="btn thunderbird" title="{{localize('remove-profile-image')}}">
            <button>{{localize('remove-profile-image')}}</button>
          </flat-button>
          <flat-button on-tap="verifyAccount" class="btn" title="{{localize('verify-account')}}" hidden="[[user.emailVerified]]">
            <button disabled="[[user.emailVerified]]">{{localize('verify-account')}}</button>
          </flat-button>
          <flat-button on-tap="saveSettings" class="btn shamrock" title="{{localize('save-settings')}}">
            <button>{{localize('save-settings')}}</button>
          </flat-button>
        </div>
      </li>
      <li>
        <div class="card">
          <h1 class="title">{{localize('authentication-settings')}}</h1>
          <paper-input label="{{localize('email')}}" id="userEmail" type="email" readonly value="[[user.email]]" always-float-label></paper-input>
          <paper-input label="{{localize('current-password')}}" id="currentPassword" type="password" always-float-label></paper-input>
          <paper-input label="{{localize('new-password')}}" id="newPassword" type="password" always-float-label></paper-input>
          <flat-button on-tap="changeAuthen" class="btn" title="{{localize('change-password')}}">
            <button>{{localize('change-password')}}</button>
          </flat-button>
          <flat-button on-tap="deleteAccount" class="btn thunderbird" title="{{localize('delete-account')}}">
            <button>{{localize('delete-account')}}</button>
          </flat-button>
        </div>
      </li>
      <li>
        <div class="card">
          <h1 class="title">{{localize('backup-settings')}}</h1>
          <p>Export or Import factory data to backup as a file.</p>
          <flat-button on-tap="exportData" class="btn" title="{{localize('export-data')}}">
            <button>{{localize('export-data')}}</button>
          </flat-button>
          <flat-button on-tap="importData" class="btn" title="{{localize('import-data')}}">
            <button>{{localize('import-data')}}</button>
            <input type="file" accept="application/json,.json" name="import-file" id="importFile" />
          </flat-button>
          <paper-toggle-button class="switch" value="[[autobackup]]" on-change="changeAutoBackup" id="autobackupSwitch" noink>{{localize('auto-backup')}}</paper-toggle-button>
        </div>
      </li>
      <li>
        <div class="card">
          <h1 class="title">{{localize('notification-settings')}}</h1>
          <p>Web Notification</p>
          <paper-toggle-button class="switch" value="[[notification]]" on-change="changeNotification" id="webNotificationSwitch" checked="[[token]]"
            noink> {{localize('notification')}}</paper-toggle-button>
          <p>E-mail Notification</p>
          <paper-toggle-button class="switch" value="[[emailalert]]" on-change="changeEmailAlert" id="emailAlertSwitch" noink>{{localize('email-notification')}}</paper-toggle-button>
        </div>
      </li>
      <li>
        <div class="card">
          <h1 class="title">{{localize('organization-settings')}}</h1>
          <p>Organization: [[usr.organization]]</p>
          <p>Data keychain: [[usr.key]]</p>
          <p>Role: [[usr.role]]</p>
          <flat-button on-tap="openManageKey" class="btn">
            <button>Manage Keychain</button>
          </flat-button>
          <flat-button on-tap="openManageUser" class="btn">
            <button>Manage User</button>
          </flat-button>
          <flat-button on-tap="resetFactory" class="btn thunderbird" title="{{localize('delete-account')}}">
            <button>Reset Factory Data</button>
          </flat-button>
        </div>
      </li>
    </ul>
    <paper-toast id="toastAlert" always-on-top horizontal-align="right" text="{{toastText}}"></paper-toast>
    <vaadin-dialog id="manageKeyDialog" class="dialog">
      <template>
        <custom-style>
          <style is="custom-style">
             :host {
              width: 50%;
              --app-primary-color: #202020;
              --paper-input-container-focus-color: var( --app-primary-color);
            }

            [part="content"] {
              padding: 20px 30px;
            }

            h1 {
              margin: 10px 0 20px 0;
            }

            .center {
              text-align: center;
            }

            .btn-group {
              float: right;
              margin: 10px 0;
            }
          </style>
        </custom-style>
        <h1 class="center">Manage Keychain</h1>
        <p>!!WARNNING!! CHANGING KEYCHAIN MIGHT LOST ALL DATA PLEASE BACKUP YOUR KEYCHAIN BEFORE CHANGE THE KEY.</p>
        <paper-input label="Data key" id="keyData" value="[[usr.key]]" type="text" always-float-label></paper-input>
        <div class="btn-group">
          <paper-button dialog-dismiss on-tap="closeKeyDialog">
            {{localize('dismiss')}}
          </paper-button>
          <paper-button dialog-confirm autofocus on-tap="updateKey">
            {{localize('save')}}
          </paper-button>
        </div>
      </template>
    </vaadin-dialog>
  </template>

  <script>
    /**
     * @ViewSettings
     * @polymer 
     * @extends {Polymer.Element}
     * @appliesMixin Polymer.AppLocalizeBehavior
     */
    class ViewSettings extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior],
      Polymer.Element) {
      static get is() {
        return 'view-settings'
      }
      static get properties() {
        return {
          route: {
            type: Object,
            notify: true
          },
          maxFiles: {
            type: Number,
            value: 1
          },
          maxFileSize: {
            type: Number,
            value: 1000000
          },
          language: String,
          notification: Boolean,
          languageItems: Array,
          user: Object,
          appdata: Object,
          emailalert: Object,
          autobackup: Object,
          statusKnown: Object,
          active: Object,
          pushSupported: Object,
          token: String,
          toastText: String
        }
      }
      static get observers() {
        return [
          'setKeyValue(usr.key)'
        ]
      }

      connectedCallback() {
        super.connectedCallback()
        this.loadResources(this.resolveUrl('../data/locales.json'))
      }

      exportData() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.appdata));
        const a = document.createElement('a');
        a.href = 'data:' + data;
        a.download = 'export.json';
        a.innerHTML = 'download JSON';
        a.click();
      }

      importData() {
        this.$.importFile.click();
      }

      openManageKey() {
        this.$.manageKeyDialog.opened = true;
      }

      openManageUser() {

      }

      closeKeyDialog() {
        this.$.manageKeyDialog.opened = false;
      }

      setKeyValue(key) {
        this.newKey = key;
      }

      updateKey() {
        if (this.newKey) {
          this.$.userData.ref.update({
            key: this.newKey
          }).then(() => {
            this.toastText = 'Updated key successful'
            this.$.toastAlert.open()
            this.closeKeyDialog();
          }).catch(err => {
            console.error(err.message);
          })
        } else {
          this.toastText = 'Key data cannot be empty.'
          this.$.toastAlert.open()
        }
      }

      _verifyUploadFile() {
        let file = this.$.uploadImageFile.files[0]
        if (!file.type.match(/image.*/)) {
          this.toastText = 'Invalid file format'
          this.$.toastAlert.open()
          this.$.uploadImageFile.value = null
        } else if (file.size > this.maxFileSize) {
          this.toastText = 'File size maximum is 1 MB'
          this.$.toastAlert.open()
          this.$.uploadImageFile.value = null
        }
      }

      saveSettings() {
        let displayNameInput = this.$.displayName.value
        if (displayNameInput !== '' && displayNameInput !== this.user.displayName) {
          this.user.updateProfile({
            displayName: displayNameInput
          })
          this.updateProfileInfo(this.user.photoURL, displayNameInput)
        }
        if (this.$.uploadImageFile.files.length > 0) {
          this.uploadProfileImage()
        }
      }

      openBrowseImageFile() {
        this.$.uploadImageFile.click();
      }

      uploadProfileImage() {
        let file = this.$.uploadImageFile.files[0]
        if (file) {
          if (file.type.match(/image.*/) && file.size < this.maxFileSize) {
            let uid = this.user.uid
            let name = this.user.displayName
            let storageRef = this.$.auth.app.storage().ref()
            let metadata = {
              'contentType': file.type
            }
            let imagesRef = storageRef.child('user/' + uid + '/profile')
            imagesRef.put(file, metadata)
              .then(snapshot => {
                let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100
                //this.$.uploadProgress.value = progress
                this.$.uploadImageFile.files.uploading = true
                this.$.uploadImageFile.files.status = snapshot.state
                this.$.uploadImageFile.files.progress = progress
                this.$.uploadImageFile.files.loaded = snapshot.bytesTransferred
                this.$.uploadImageFile.files.size = snapshot.totalBytes
                let url = snapshot.metadata.downloadURLs[0]
                this.user.updateProfile({
                  photoURL: url
                }).catch(function (error) {
                  this.$.uploadImageFile.files.error = error
                  this.$.uploadImageFile.value = null
                  console.error('Upload failed:', error)
                })
                if (url) {
                  this.$.uploadImageFile.files.complete = true
                  this.updateProfileInfo(url, name)
                }
              })
          } else {
            this.toastText = 'Error: Invalid file format'
            this.$.toastAlert.open()
            this.$.uploadImageFile.value = null
          }
        }
      }

      updateProfileInfo(url, name) {
        this.$.userData.ref.update({
            displayname: name,
            photoURL: url
          })
          .then(() => {
            this.toastText = 'notification-save-settings'
            this.$.toastAlert.open()
            this.$.uploadImageFile.files[0] = null
          })
          .catch(error => {
            this.$.uploadImageFile.value = null
          })
      }

      deleteProfileImage() {
        if (this.user.photoURL) {
          if (window.confirm('Delete profile image ?') === true) {
            let storageRef = firebase.app('smart-mes').storage().ref('user/' + this.user.uid + '/profile')
            // Delete the file
            storageRef.delete()
              .then(() => {
                this.user.updateProfile({
                  photoURL: null
                })
                this.toastText = 'notification-delete-profile-image-successful'
                this.$.toastAlert.open()
              })
              .catch(error => {
                console.error('Error delete file:', error)
                this.toastText = `Error delete image file ${error} Please try again.`
                this.$.toastAlert.open()
              })
          }
        } else {
          this.toastText = 'No image file to delete'
          this.$.toastAlert.open()
        }
      }

      changeLanguage() {
        let selectedLang = this.$.languageSelector.value
        if (selectedLang) {
          if (selectedLang === "en" || selectedLang === "th" || selectedLang === "jp" || selectedLang === "ch" ||
            selectedLang === "rs") {
            this.language = selectedLang
          } else {
            this.language = "en"
          }
        }
      }

      changeAutoBackup() {
        this.autobackup = this.$.autobackupSwitch.checked
        if (this.$.autobackupSwitch.checked) {
          this.toastText = 'autobackup-notification-alert-on'
          this.$.toastAlert.open()
        } else {
          this.toastText = 'autobackup-notification-alert-off'
          this.$.toastAlert.open()
        }
      }

      changeNotification() {
        this.notification = this.$.webNotificationSwitch.checked
        if (this.$.webNotificationSwitch.checked) {
          // Requesting notification permission
          this.$.messaging.requestPermission()
            .then(() => {
              console.log("%cWeb notification permission granted", 'color:green');
              this.toastText = 'notification-alert-on'
              this.$.toastAlert.open()
            })
            .catch(err => {
              console.error("Web notification permission denied", err);
            });
        } else {
          this.toastText = 'notification-alert-off'
          this.$.toastAlert.open()
        }
      }

      changeEmailAlert() {
        this.emailAlert = this.$.emailAlertSwitch.checked
        if (this.$.emailAlertSwitch.checked) {
          this.toastText = 'email-notification-alert-on'
          this.$.toastAlert.open()
        } else {
          this.toastText = 'email-notification-alert-off'
          this.$.toastAlert.open()
        }
      }

      changeAuthen() {
        let currentpassword = this.$.currentPassword.value
        let newPassword = this.$.newPassword.value
        let newemail = this.$.userDataEmail.value
        if (newPassword !== '' && currentpassword !== '') {
          if (this._reauthenAccount(currentpassword)) {
            this.user.updatePassword(newPassword)
              .then(() => {
                this.toastText = 'Updated your password successful, you will need to relogin'
                this.$.toastAlert.open()
              })
              .catch(err => {
                console.error('Error: ' + err.message)
              })
          } else {
            this.toastText = 'Wrong password'
            this.$.toastAlert.open()
          }
        }

        if (newemail !== '') {
          this.user.updateEmail(newemail)
            .then(() => {
              this.toastText = 'Updated your email successful, you will need to relogin'
              this.$.toastAlert.open()
            })
            .catch(err => {
              console.error('Error: ' + err.message)
            })
        }
      }

      deleteAccount() {
        if (window.confirm('!! WARNNING !! Delete this account ? Your data will permanently delete.') === true) {
          let password = prompt("Enter your current password", "");
          if (this._reauthenAccount(password)) {
            this.$.appData.ref.remove();
            this.$.userData.ref.remove();
            this.$.auth.delete().then(function () {
              window.alert("Delete successful, you'll now logout")
              this.logout()
            }, function (error) {
              console.error(error)
            })
          }
        }
      }

      logout() {
        this.$.auth.signOut()
          .then(() => {
            this.authen = false
            // redirect to login page
            this.async(function () {
              this.set('route.path', 'login')
              this.page = 'login'
            }, 500)
          })
          .catch((error) => {
            console.error('%cAuthenticate Failed: ' + error.code, 'color: crimson;')
            this.toastText = `Authenticate Failed: ${error.message} Please try again.`
            this.$.toastAlert.open()
          })
      }

      scanDevice() {
        if ('usb' in navigator) {
          let device
          device = navigator.usb.requestDevice({
              filters: [{
                vendorId: 0x2341
              }, {
                vendorId: 0x2a03
              }]
            })
            .then(device => {
              console.log(device.productName) // "Arduino Micro"
              console.log(device.manufacturerName) // "Arduino LLC"
            })
            .catch(error => {
              console.error(error)
            })

          if (device !== undefined) {
            // Add |device| to the UI.
          }
        } else {
          window.alert('Your web browser is not support physical device detection. Please use Google Chrome')
        }
      }

      showDevice() {
        if ('usb' in navigator) {
          navigator.usb.getDevices().then(devices => {
              devices.map(device => {
                console.log(device.productName) // "Arduino Micro"
                console.log(device.manufacturerName) // "Arduino LLC"
                console.log(device.vendorId) // "Vender ID"
              })
            })
            .catch(error => {
              console.error(error)
            })
        } else {
          window.alert('Your web browser is not support physical device detection. Please use Google Chrome')
        }
      }

      verifyAccount() {
        if (!this.user.emailVerified) {
          this.user.sendEmailVerification()
            .then(() => {
              this.toastText = 'Verification link has been sent to your email'
              this.$.toastAlert.open()
            })
            .catch(err => {
              console.error('Error: ' + err.message)
            })
        }
      }

      _reauthenAccount(currentpassword) {
        let credential = this.$.auth.EmailAuthProvider.credential(this.user.email, currentpassword)
        this.user.reauthenticateWithCredential(credential)
          .then(() => {
            return true
          })
          .catch(err => {
            console.error('Error: ' + err.message)
            return false
          })
      }

      handleMessage(message) {
        console.log(message)
        console.log('message received', arguments)
      }
    }

    window.customElements.define(ViewSettings.is, ViewSettings)
  </script>
</dom-module>