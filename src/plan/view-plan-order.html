<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-material-theme/vaadin-date-picker.html">
<link rel="import" href="../view-setup.html">
<link rel="import" href="../style/shared-styles.html">
<link rel="import" href="../style/flat-button.html">

<dom-module id="view-plan-order">
    <template>
        <style include="shared-styles app-grid-style flat-button">
             :host {
                margin: 10px;
                display: block;
                --app-grid-item-height: 50%;
            }

            @media (min-width: 360px) and (max-width: 768px) {
                 :host {
                    --app-grid-columns: 1;
                }
            }

            @media (min-width: 769px) and (max-width: 1024px) {
                 :host {
                    --app-grid-columns: 1;
                }
            }

            @media (min-width: 1025px) and (max-width: 1200px) {
                 :host {
                    --app-grid-columns: 2;
                }
            }

            @media (min-width: 1201px) and (max-width: 2560px) {
                 :host {
                    --app-grid-columns: 2;
                }
            }

            vaadin-date-picker.date-picker {
                width: 100%;
            }

            .order-info>p {
                margin: 16px 0;
            }

            .flex-container {
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: row;
            }

            .wrap {
                -webkit-flex-flow: row wrap;
                flex-flow: row wrap;
            }

            .flex-item {
                flex: 1;
            }

            .left-group>p {
                font-weight: 500;
            }

            .right-group>p {
                font-weight: 400;
            }

            .flex-item>p {
                margin: 12px 0;
            }

            .frame {
                padding: 10px;
            }

            .frame-small {
                width: 33.333%;
                margin: 10px;
            }
        </style>
        <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
        <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]" data="{{k}}"></firebase-document>
        <firebase-query app-name="smart-mes" id="orderQuery" path="/data/[[k.key]]/orderData" data="{{orderItems}}"></firebase-query>
        <firebase-document app-name="smart-mes" id="factoryPerformance" path="/data/[[k.key]]/factoryData/performance" data="{{factoryPerformance}}"></firebase-document>
        <firebase-query app-name="smart-mes" id="historyQuery" path="/data/[[k.key]]/historyData/order"></firebase-query>
        <firebase-query app-name="smart-mes" id="notificationQuery" path="/data/[[k.key]]/notificationData"></firebase-query>
        <firebase-query app-name="smart-mes" id="customerQuery" path="/data/[[k.key]]/customerData" order-by-child="fname" data="{{customerItems}}"></firebase-query>
        <firebase-query app-name="smart-mes" id="productQuery" path="/data/[[k.key]]/factoryData/product" order-by-child="name" data="{{productItems}}"></firebase-query>
        <app-localstorage-document key="app-lang" data="{{language}}"></app-localstorage-document>
        <ul class="app-grid">
            <li>
                <div class="card">
                    <h1 class="title">Create Order</h1>
                    <vaadin-combo-box label="Customer Name" name="customer-name" id="customerSelector" items="[[customerItems]]" item-label-path="name"
                        item-value-path="name" selected-item='{{selectCustomer}}' loading="[[!customerItems]]" required allow-custom-value
                        prevent-invalid-input always-float-label>
                        <template>
                            <paper-item>
                                <paper-item-body two-line style="min-height: 0">
                                    <div style="text-transform: capitalize">[[item.name]]</div>
                                    <div secondary>[[item.email]]</div>
                                </paper-item-body>
                            </paper-item>
                        </template>
                    </vaadin-combo-box>
                    <vaadin-combo-box label="Product" name="product" items="[[productItems]]" id="productSelector" item-label-path="name" item-value-path="name"
                        selected-item='{{selectProduct}}' loading="[[!productItems]]" required prevent-invalid-input always-float-label>
                        <template>
                            <paper-icon-item style="padding: 0">
                                <img src="[[item.image]]" style="border-radius: 50%; width: 48px; height: 48px;" slot="item-icon">
                                <paper-item-body two-line style="min-height: 0">
                                    <div style="text-transform: capitalize">[[item.name]]</div>
                                    <div secondary>SKU: [[item.sku]]</div>
                                </paper-item-body>
                            </paper-icon-item>
                        </template>
                    </vaadin-combo-box>
                    <paper-input label="Quantity" name="order-quantity" value='{{amount}}' id="orderQuantity" type="number" min="1" max="1000"
                        step="1" allowed-pattern="[0-9]" required always-float-label></paper-input>
                    <vaadin-date-picker class="date-picker" label="Delivery Date" min="2017-01-01" max="2040-01-01" name="delivery" id="deliverySelector"
                        value="{{delivery}}" error-message="Invalid input" required always-float-label></vaadin-date-picker>
                    <!-- <vaadin-upload id="uploadOrder" max-files="1" accept=".csv" max-file-size="1000000"></vaadin-upload> -->
                    <flat-button on-tap="saveValue" class="btn" title="Save to archive"><button>Save Order</button></flat-button>
                    <flat-button on-tap="createOrder" class="shamrock btn" title="Add order"><button>Add to schedule</button></flat-button>
                </div>
            </li>
            <li>
                <div class="card order-info">
                    <h1 class="title">Order Detail</h1>
                    <div class="flex-container">
                        <div class="flex-item left-group">
                            <p>Order Number</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>Customer Name</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>Product Name</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>SKU Number</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>Product Part</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>Actual Quantity</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>Order Duration</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>Delivery Date</p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p>Cost</p>
                        </div>
                        <div class="flex-item right-group">
                            <p><span>[[getOrderNumber(orderItems.length)]]</span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span>[[selectCustomer.name]]</span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span>[[setProductPart(selectProduct)]]</span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span>[[setProductSKU(selectProduct.sku)]]</span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span><template is="dom-repeat" items="[[selectProduct.part]]" as="productPart">
                                          [[productPart.name]]
                                      </template></span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span>[[getActualQuantity(amount)]]</span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span>[[getSumProductTime(selectProduct.part,amount)]]</span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span>[[delivery]]</span></p>
                            <div class="sidebar-menu-line" role="separator"></div>
                            <p><span>[[getProductCost(selectProduct.cost,amount)]]</span></p>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
        <div class="card">
            <h1 class="title">Product Fragmentation</h1>
            <div class="flex-container">
                <template is="dom-repeat" items="{{selectProduct.part}}" as="part">
                    <div class="frame frame-small flex-item">
                        <h2 class="title">Product Part [[part.name]]</h2>
                        <p>Part SKU: [[part.sku]]</p>
                        <p>Process Sequence: [[getProductProcess(part.process)]]</p>
                        <p>Setup Time : [[getSumSetupTime(part.setup)]] minutes</p>
                        <p>Cycle Time : [[getSumCycleTime(part.cycle)]] minutes</p>
                    </div>
                </template>
            </div>
        </div>
    </template>
    <script src="../../node_modules/sugar/dist/sugar.min.js"></script>
    <script>
        class ViewPlanOrder extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior],
            Polymer.Element) {
            static get is() {
                return 'view-plan-order'
            }

            static get properties() {
                return {
                    language: String,
                    orderNumber: Number,
                    orderItems: Object,
                    factoryPerformance: Object,
                    orderProductPart: Object,
                    productSKU: Number,
                    actualQuantity: Number
                }
            }

            ready() {
                super.ready();
                this._setupDatePicker();
            }
            connectedCallback() {
                super.connectedCallback()
                this.loadResources(this.resolveUrl('../../data/locales.json'))
            }

            // GET VALUE

            getOrderNumber(o) {
                if (o == 0 || o == null) {
                    this.orderNumber = 1; // set to global variable
                    return this.orderNumber
                } else {
                    this.orderNumber = o + 2; // start index is 0 
                    return this.orderNumber
                }
            }

            getActualQuantity(amount) {
                if (!amount) return 0;
                let accept_waste = this.factoryPerformance.aw;
                let actual_quantity = Math.ceil((amount / (1 - accept_waste)));
                this.actualQuantity = actual_quantity; // set to global variable
                return actual_quantity;
            }

            getSumProductTime(part, amount) {
                if (!part || !amount) return 0;
                let productCycleArr = []
                let productSetupArr = []
                let partArr = Object.values(part); // convert obj to arr
                for (let i = part.length; i--;) {
                    productCycleArr.push(partArr[i].cycle) // loop push cycle arr to big arr
                }
                for (let i = part.length; i--;) {
                    productSetupArr.push(partArr[i].setup) // loop push setup arr to big arr
                }
                let flatCycleArr = [].concat(...productCycleArr); // flat subarr concat to arr
                let flatSetupArr = [].concat(...productSetupArr); // flat subarr concat to arr
                let sumCycle = flatCycleArr.reduce((a, b) => a + b); // reduce arr to get sumCycle
                let sumSetup = flatSetupArr.reduce((a, b) => a + b); // reduce arr to get sumCycle
                let sumDuration = (sumSetup + (sumCycle * this.getActualQuantity(amount))); // sumCycle * quantity
                this.orderDuration = sumDuration;
                return this._minutesToStr(sumDuration); // convert to hr and min
            }

            getProductCost(cost, amount) {
                if (!cost || !amount) return 0;
                let actual_amount = this.getActualQuantity(amount);
                let total_cost = (cost * actual_amount);
                return total_cost;
            }

            // PRODUCT VIEWER SECTION
            getProductProcess(process) {
                if (!process) {
                    return 0;
                }
                return process.split(',').join(' → ');
            }

            getSumSetupTime(setup) {
                if (!setup) return 0;
                let sumSetupTime = setup.reduce((a, b) => a + b);
                return sumSetupTime.toFixed(1);
            }

            getSumCycleTime(cycle) {
                if (!cycle) return 0;
                let sumCycleTime = cycle.reduce((a, b) => a + b);
                return sumCycleTime.toFixed(1);
            }

            // SET VALUE

            setProductPart(product) {
                if (!product) return 0;
                this.orderProductPart = product.part; // set to global variable
                return product.name;
            }

            setProductSKU(sku) {
                if (!sku) return 0;
                this.productSKU = sku; // set to global variable
                return sku;
            }

            // CONVERT TIME TO STRING
            _minutesToStr(minute) {
                let sign = '';
                if (minute < 0) {
                    sign = '0';
                }
                let hours = this._leftPad(Math.floor(Math.abs(minute) / 60));
                let minutes = this._leftPad(Math.round(Math.abs(minute) % 60));
                return sign + hours + 'hrs ' + minutes + 'min';
            }

            // ADD 0 to numbers less than 10,Eg: 2 -> 02 
            _leftPad(number) {
                return ((number < 10 && number >= 0) ? '0' : '') + number;
            }

            // SETUP CALENDAR DATE PICKER FORMAT
            _setupDatePicker() {
                Sugar.Date.setLocale('en-GB'); // USE SUGAR LIBRARY TO REF FROM LOCALE DATE FORMAT
                let deliverypicker = this.$.deliverySelector;
                deliverypicker.addEventListener('value-changed', function () {
                    let deliveryTimeStamp = (new Date(deliverypicker.value).getTime() / 1000);
                    this.orderDelivery = deliveryTimeStamp;
                });
                // INTERNATIONA LOCALIZATION
                deliverypicker.i18n = {
                    week: 'Week',
                    calendar: 'Calendar',
                    clear: 'Clear',
                    today: 'Today',
                    cancel: 'Cancel',
                    firstDayOfWeek: 1,
                    monthNames: 'January_February_March_April_May_June_July_August_September_October_November_December'.split(
                        '_'),
                    weekdays: 'sunday_monday_tuesday_wednesday_thursday_friday_saturday'.split('_'),
                    weekdaysShort: 'sun_mon_tue_wed_thu_fri_sat'.split('_'),
                    formatDate: function (date) {
                        return Sugar.Date.format(date, '{short}');
                    },
                    formatTitle: function (monthName, fullYear) {
                        return monthName + ' ' + fullYear;
                    },
                    parseDate: function (dateString) {
                        let matches = deliverypicker.i18n.monthNames.filter(function (monthName) {
                            return monthName.toLowerCase().startsWith(dateString.trim().toLowerCase());
                        });
                        dateString = matches.length === 1 ? matches[0] : dateString;
                        return Sugar.Date.create(dateString);
                    }
                }
            }

            // CLEAR INPUT FORM FIELD
            _clearField() {
                this.$.customerSelector.value = "";
                this.$.productSelector.value = "";
                this.$.orderQuantity.value = 1;
                this.$.deliverySelector.value = "";
            }

            // SAVE ORDER
            saveOrder() {
                alert('Saved order to order save list successful');
                _clearField();
            }

            // CREATE ORDER
            createOrder() {
                let orderNo = this.orderNumber;
                let customerID = this.$.customerSelector.value;
                let orderDate = Math.round(new Date().getTime() / 1000.0);
                let orderProductName = this.$.productSelector.value;
                let orderProductPart = this.orderProductPart;
                let orderProductSKU = this.productSKU;
                let orderQuantity = this.actualQuantity;
                let orderDuration = this.orderDuration;
                let orderDelivery = (new Date(this.$.deliverySelector.value).getTime() / 1000);

                if (orderNo !== "" && customerID !== "" && orderProductName !== "" && orderProductPart !== "" &&
                    orderProductSKU !== "" && orderQuantity !== "" && !(isNaN(orderDelivery))) {

                    this.$.orderQuery.ref.push({
                        order_date: orderDate,
                        order_no: orderNo,
                        order_customer: customerID,
                        order_product_name: orderProductName,
                        order_product_part: orderProductPart,
                        order_product_sku: orderProductSKU,
                        order_quantity: orderQuantity,
                        order_duration: orderDuration,
                        order_delivery: orderDelivery,
                        order_status: "waiting",
                    });
                    this.$.historyQuery.ref.push({
                        order_date: orderDate,
                        order_delivery: orderDelivery,
                        order_no: orderNo,
                        order_customer: customerID,
                        order_product: orderProductName,
                        order_quantity: orderQuantity
                    });

                    let detail = 'Created order no.' + orderNo;
                    this.$.notificationQuery.ref.push({
                        created: orderDate,
                        detail: detail,
                        type: 'nornal'
                    });
                    alert("Added to production schedule successfully");
                    this._clearField();
                } else {
                    alert("Input field cannot be blank, please fill in completely.");
                }
            }
        }
        customElements.define(ViewPlanOrder.is, ViewPlanOrder)
    </script>
</dom-module>