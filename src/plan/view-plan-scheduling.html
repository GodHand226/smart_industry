<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/vaadin-charts/vaadin-charts.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../view-setup.html">
<link rel="import" href="../style/shared-styles.html">
<link rel="import" href="../style/flat-button.html">

<dom-module id="view-plan-scheduling">
    <template>
        <style include="shared-styles app-grid-style flat-button">
             :host {
                margin: 10px;
                display: block;
                --app-grid-columns: 1;
                --app-grid-item-height: 50%;
            }

            @media (min-width: 360px) and (max-width: 768px) {
                .btn {
                    width: 100%;
                }
            }

            .btn {
                margin: 20px 10px 0 0;
                width: 250px;
            }

            vaadin-grid#material {

                font-family: Roboto, sans-serif;
                --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));

                --vaadin-grid-cell: {
                    padding: 0;
                }
                ;

                --vaadin-grid-header-cell: {
                    height: 64px;
                    color: rgba(0, 0, 0, var(--dark-secondary-opacity));
                    font-size: 12px;
                }
                ;

                --vaadin-grid-body-cell: {
                    height: 48px;
                    color: rgba(0, 0, 0, var(--dark-primary-opacity));
                    font-size: 13px;
                }
                ;

                --vaadin-grid-body-row-hover-cell: {
                    background-color: var(--paper-grey-200);
                }
                ;

                --vaadin-grid-body-row-selected-cell: {
                    background-color: var(--paper-grey-100);
                }
                ;

                --vaadin-grid-focused-cell: {
                    box-shadow: none;
                    font-weight: bold;
                }
                ;
            }

            vaadin-grid#material .cell {
                overflow: hidden;
                text-overflow: ellipsis;
                padding-right: 56px;
            }

            vaadin-grid#material .cell.last {
                padding-right: 24px;
            }

            vaadin-grid#material .cell.numeric {
                text-align: right;
            }

            vaadin-grid#material paper-checkbox {
                --primary-color: var(--paper-indigo-500);
                margin: 0 24px;
            }

            vaadin-grid#material vaadin-grid-sorter {
                --vaadin-grid-sorter-arrow: {
                    display: none !important;
                }
                ;
            }

            vaadin-grid#material vaadin-grid-sorter .cell {
                flex: 1;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            vaadin-grid#material vaadin-grid-sorter iron-icon {
                transform: scale(0.8);
            }

            vaadin-grid#material vaadin-grid-sorter:not([direction]) iron-icon {
                color: rgba(0, 0, 0, var(--dark-disabled-opacity));
            }

            vaadin-grid#material vaadin-grid-sorter[direction] {
                color: rgba(0, 0, 0, var(--dark-primary-opacity));
            }

            vaadin-grid#material vaadin-grid-sorter[direction=desc] iron-icon {
                transform: scale(0.8) rotate(180deg);
            }
        </style>
        <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
        <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]" data="{{k}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factoryProfile" path="/data/[[k.key]]/factoryData/profile" data="{{factoryProfile}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factoryOperation" path="/data/[[k.key]]/factoryData/operation" data="{{factoryOperation}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factoryPerformance" path="/data/[[k.key]]/factoryData/performance" data="{{factoryPerformance}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factorySchedule" path="/data/[[k.key]]/factoryData/schedule" data="{{factorySchedule}}"></firebase-document>

        <firebase-query app-name="smart-mes" id="schedulingQuery" path="/data/[[k.key]]/schedulingData" order-by-child="scheduling_no"
            scheduling-by-value="true" data="{{schedulingItems}}"></firebase-query>
        <firebase-query app-name="smart-mes" id="orderQuery" path="/data/[[k.key]]/orderData" order-by-child="order_no" order-by-value="true"
            data="{{orderItems}}"></firebase-query>

        <firebase-query app-name="smart-mes" id="productQuery" path="/data/[[k.key]]/factoryData/product" order-by-child="id" scheduling-by-value="true"
            data="{{productItems}}"></firebase-query>

        <app-localstorage-document key="app-lang" data="{{language}}"></app-localstorage-document>

        <ul class="app-grid">
            <li>
                <div class="card">
                    <h1 class="title">Order Scheduling</h1>
                    <p>Next Reschedule: [[getNextInterval(factorySchedule.start_interval, factorySchedule.interval)]]</p>
                    <p>Production Model: [[factoryProfile.model]]</p>
                    <vaadin-grid id="material" items="[[orderItems]]" size="200">

                        <vaadin-grid-selection-column width="66px" flex="0" select-all="{{selectAll}}">
                            <template class="header">
                                <paper-checkbox checked="{{selectAll}}"></paper-checkbox>
                            </template>
                            <template>
                                <paper-checkbox checked="{{selected}}"></paper-checkbox>
                            </template>
                        </vaadin-grid-selection-column>

                        <vaadin-grid-column width="100px" flex="0">
                            <template class="header">
                                <div class="cell">Order No.</div>
                            </template>
                            <template>
                                <div class="cell">[[item.order_no]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="2">
                            <template class="header">
                                <div class="cell">Customer</div>
                            </template>
                            <template>
                                <div class="cell">[[item.order_customer]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <vaadin-grid-sorter path="location.city">
                                    <div class="cell">
                                        <span>Product</span>
                                        <iron-icon icon="vaadin:arrow-up"></iron-icon>
                                    </div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[item.order_product_name]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <vaadin-grid-sorter path="location.city">
                                    <div class="cell">
                                        <span>Quantity</span>
                                        <iron-icon icon="vaadin:arrow-up"></iron-icon>
                                    </div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[item.order_quantity]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Duration (hr)</div>
                            </template>
                            <template>
                                <div class="cell">[[item.order_duration]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Remaining (day)</div>
                            </template>
                            <template>
                                <div class="cell">[[getRemainDay(item.order_date,item.order_delivery)]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="100px" flex="0">
                            <template class="header">
                                <div class="cell numeric last">Delete</div>
                            </template>
                            <template>
                                <div class="cell numeric last">
                                    <paper-icon-button on-tap="_deleteOrder" order="[[item]]" icon="vaadin:trash" title="Delete"></paper-icon-button>
                                </div>
                            </template>
                        </vaadin-grid-column>

                    </vaadin-grid>
                    <div class="center">
                        <flat-button class="btn" on-tap="_refreshStatus"><button>Manage Order</button></flat-button>
                        <flat-button class="btn thunderbird" on-tap="_refreshStatus"><button>Reschedule</button></flat-button>
                    </div>
                </div>
            </li>
            <li>
                <div class="card">
                    <h1 class="title">Job Scheduling and Work station Workload</h1>

                    <vaadin-grid id="material" items="[[items]]" size="200">

                        <vaadin-grid-selection-column width="66px" flex="0" select-all="{{selectAll}}">
                            <template class="header">
                                <paper-checkbox checked="{{selectAll}}"></paper-checkbox>
                            </template>
                            <template>
                                <paper-checkbox checked="{{selected}}"></paper-checkbox>
                            </template>
                        </vaadin-grid-selection-column>

                        <vaadin-grid-column width="100px" flex="0">
                            <template class="header">
                                <div class="cell">Order No.</div>
                            </template>
                            <template>
                                <div class="cell">[[item.name.first]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="2">
                            <template class="header">
                                <div class="cell">Customer</div>
                            </template>
                            <template>
                                <div class="cell">[[item.email]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <vaadin-grid-sorter path="location.city">
                                    <div class="cell">
                                        <span>Product</span>
                                        <iron-icon icon="vaadin:arrow-up"></iron-icon>
                                    </div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[item.location.city]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <vaadin-grid-sorter path="location.city">
                                    <div class="cell">
                                        <span>Quantity</span>
                                        <iron-icon icon="vaadin:arrow-up"></iron-icon>
                                    </div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[item.location.city]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="100px" flex="0">
                            <template class="header">
                                <div class="cell numeric last">Delete</div>
                            </template>
                            <template>
                                <div class="cell numeric last">
                                    X
                                </div>
                            </template>
                        </vaadin-grid-column>
                    </vaadin-grid>
                    <div class="center">
                        <flat-button class="btn shamrock" on-tap="_refreshStatus"><button>Start Work</button></flat-button>
                    </div>
                </div>
            </li>

            <li>
                <div class="card">
                    <h1 class="title">Job Scheduling Gantt Chart</h1>

                    <vaadin-columnrange-chart id="column-range-resource-usage">
                        <chart inverted="true"></chart>
                        <chart-title>Resource usage</chart-title>
                        <x-axis>
                            <categories>Printer, Coffee machine</categories>
                        </x-axis>
                        <y-axis type="datetime">
                            <chart-title>Time</chart-title>
                        </y-axis>
                        <tooltip formatter="function () {return this.series.name +': '+ Highcharts.dateFormat('%H:%M', this.point.low) + ' - ' + Highcharts.dateFormat('%H:%M', this.point.high)}"></tooltip>
                        <plot-options>
                            <columnrange grouping="false">
                                <data-labels enabled="true" inside="true" color="white" formatter="function () {return this.y == this.point.low ? '' : this.series.name;}"></data-labels>

                            </columnrange>
                        </plot-options>
                        <data-series name="Team Alpha">
                            <color>rgba(255, 60, 125, 1.0)</color>
                            <data>[Date.UTC(2013,5,7,12,0,0),Date.UTC(2013,5,7,15,0,0)], [Date.UTC(2013,5,7,13,0,0),Date.UTC(2013,5,7,17,0,0)]
                            </data>
                        </data-series>
                        <data-series name="Team Beta">
                            <color>rgba(60, 125, 255, 1.0)</color>
                            <data>[Date.UTC(2013,5,7,16,0,0),Date.UTC(2013,5,7,17,0,0)], [Date.UTC(2013,5,7,12,0,0),Date.UTC(2013,5,7,14,0,0)]
                            </data>
                        </data-series>

                    </vaadin-columnrange-chart>

                    <vaadin-columnrange-chart id="column-range">
                        <chart inverted="true"></chart>
                        <chart-title>Temperature variation by month</chart-title>
                        <subtitle>Observed in Vik i Sogn, Norway</subtitle>
                        <x-axis>
                            <categories>Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec</categories>
                        </x-axis>
                        <y-axis>
                            <chart-title>Temperature ( °C )</chart-title>
                        </y-axis>
                        <tooltip value-suffix="°C"></tooltip>
                        <plot-options>
                            <columnrange>
                                <data-labels enabled="true" formatter="function () {return this.y + '°C';}"></data-labels>
                            </columnrange>
                        </plot-options>
                        <legend enabled="false"></legend>
                        <data-series name="Temperatures">
                            <data>
                                [-9.7, 9.4], [-8.7, 6.5], [-3.5, 9.4], [-1.4, 19.9], [0.0, 22.6], [2.9, 29.5], [9.2, 30.7], [7.3, 26.5], [4.4, 18.0], [-3.1,
                                11.4], [-5.2, 10.4], [-13.5, 9.8]
                            </data>
                        </data-series>
                    </vaadin-columnrange-chart>
                </div>
            </li>
        </ul>
    </template>
    <script>
        class ViewPlanScheduling extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior],
            Polymer.Element) {
            static get is() {
                return 'view-plan-scheduling'
            }

            static get properties() {
                return {
                    language: String
                }
            }
            connectedCallback() {
                super.connectedCallback()
                this.loadResources(this.resolveUrl('../../data/locales.json'))
            }

            getNextInterval(last_timestamp, interval) {
                if (!last_timestamp || !interval) return 0
                let current = Math.floor(Date.now() / 1000)
                let diff = current - last_timestamp
                let range = interval * 24 * 60 * 60
                if (diff <= range) {
                    let nextIntervalStamp = (last_timestamp * 1000) + (interval * 24 * 60 * 60 * 1000)
                    let nextIntervalDate = new Date(nextIntervalStamp)
                    let dd = nextIntervalDate.getDate()
                    let mm = nextIntervalDate.getMonth() + 1 // January is 0!
                    let yyyy = nextIntervalDate.getFullYear()
                    if (dd < 10) {
                        dd = '0' + dd
                    }
                    if (mm < 10) {
                        mm = '0' + mm
                    }
                    let nextInterval = dd + '/' + mm + '/' + yyyy
                    return nextInterval
                } else {
                    this.set('factorySchedule.start_interval', current)
                }
            }

            getRemainDay(order_date, delivery_date) {
                if (!order_date || !delivery_date) return 0
                if (delivery_date <= order_date) {
                    return 0;
                } else {
                    let remain = delivery_date - order_date
                    let day = (remain / 86400)
                    return Math.trunc(day)
                }
            }
        }
        customElements.define(ViewPlanScheduling.is, ViewPlanScheduling)
    </script>
</dom-module>