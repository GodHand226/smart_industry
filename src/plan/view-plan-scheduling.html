<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="/bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="/bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="/bower_components/google-chart/google-chart.html">
<link rel="import" href="/bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../view-app.html">
<link rel="import" href="../style/shared-styles.html">
<link rel="import" href="../style/flat-button.html">

<dom-module id="view-plan-scheduling">
    <template>
        <style include="shared-styles app-grid-style flat-button">
             :host {
                margin: 10px;
                display: block;
                --app-grid-columns: 1;
                --app-grid-item-height: 50%;
            }

            .btn {
                margin: 20px 10px 0 0;
                width: 250px;
            }

            .order-schedule-info {
                margin: 10px 0;
            }

            .order-schedule-info>p {
                margin: 10px 0;
            }

            .flex-container {
                display: flex;
                align-content: center;
                justify-content: space-between;
                flex-flow: row nowrap;
            }

            .station-btn {
                margin: 5px;
                width: 200px;
            }

            .btn-group {
                margin-top: 20px;
            }

            @media (min-width: 360px) and (max-width: 768px) {
                .btn {
                    width: 100%;
                }
            }

            google-chart {
                height: auto;
                width: 100%;
            }
        </style>
        <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
        <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]" data="{{k}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factoryProfile" path="/data/[[k.key]]/factoryData/profile" data="{{factoryProfile}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factoryOperation" path="/data/[[k.key]]/factoryData/operation" data="{{factoryOperation}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factoryPerformance" path="/data/[[k.key]]/factoryData/performance" data="{{factoryPerformance}}"></firebase-document>
        <firebase-document app-name="smart-mes" id="factorySchedule" path="/data/[[k.key]]/factoryData/schedule" data="{{factorySchedule}}"></firebase-document>

        <!-- STATION -->
        <firebase-query app-name="smart-mes" id="stationQuery" path="/data/[[k.key]]/factoryData/station" order-by-child="st_number"
            data="{{stationItems}}"></firebase-query>
        <!-- ORDER TABLE -->
        <firebase-query app-name="smart-mes" id="orderQuery" path="/data/[[k.key]]/orderData" order-by-child="order_delivery" data="{{orderItems}}"></firebase-query>
        <!-- CHART DATA -->
        <firebase-document app-name="smart-mes" id="chartQuery" path="/data/[[k.key]]/chartData" data="{{chartItems}}"></firebase-document>
        <!-- STATION QUERY SELECTED BY STATION NUMBER -->
        <firebase-query app-name="smart-mes" id="selectStationQuery" path="/data/[[k.key]]/factoryData/station" order-by-child="st_number"
            equal-to="{{selectedStation}}" data="{{selectedStationData}}"></firebase-query>
        <!-- JOB SCHEDULE TABLE SELECTED BY STATION NUMBER -->
        <firebase-query app-name="smart-mes" id="scheduleQuery" path="/data/[[k.key]]/scheduleData" equal-to="[[selectedStation]]"
            order-by-child="job_station" data="{{scheduleItems}}"></firebase-query>

        <app-localstorage-document key="app-lang" data="{{language}}"></app-localstorage-document>
        <ul class="app-grid">
            <li>
                <div class="card">
                    <h1 class="title">{{localize('order-table')}}</h1>
                    <div class="order-schedule-info">
                        <p>{{localize('next-reschedule')}}: [[getNextInterval(factorySchedule.start_interval, factorySchedule.interval)]]</p>
                        <p>{{localize('production-model')}}: [[factoryProfile.model]]</p>
                        <p id="concurrency">{{localize('station-concurrency')}} : [[factoryProfile.concurrency]] {{localize('order')}} / {{localize('station')}}</p>
                        <p>Delayed between station: [[factorySchedule.delay]] minutes</p>
                    </div>
                    <vaadin-grid id="orderTable" items="{{getSortedOrder(orderItems)}}" page-size="20" interacting>
                        <vaadin-grid-selection-column width="66px" flex="0" select-all="{{selectAll}}">
                            <template class="header">
                                <paper-checkbox checked="{{selectAll}}"></paper-checkbox>
                            </template>
                            <template>
                                <paper-checkbox checked="{{selected}}"></paper-checkbox>
                            </template>
                        </vaadin-grid-selection-column>

                        <vaadin-grid-column width="100px" flex="0">
                            <template class="header">
                                <vaadin-grid-sorter path="order_no">
                                    <div class="cell">Order No.</div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[item.order_no]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <vaadin-grid-sorter path="order_status">
                                    <div class="cell">Color</div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell" style$="color:[[item.order_color]]">&#9608;</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="2">
                            <template class="header">
                                <div class="cell">Customer</div>
                            </template>
                            <template>
                                <div class="cell">[[item.order_customer]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <vaadin-grid-sorter path="order_product_name">
                                    <div class="cell">
                                        <span>Product</span>
                                    </div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[item.order_product_name]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <vaadin-grid-sorter path="order_quantity">
                                    <div class="cell">
                                        <span>Quantity</span>
                                    </div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[item.order_quantity]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <vaadin-grid-sorter path="order_duration">
                                    <div class="cell">Duration (hr)</div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[getOrderDuration(item.order_duration)]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <vaadin-grid-sorter path="order_delivery">
                                    <div class="cell">Remaining</div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[getRemainDay(item.order_delivery, item.order_status, item.$key)]] days</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <vaadin-grid-sorter path="order_delivery">
                                    <div class="cell">Delivery</div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell">[[getDeliveryDate(item.order_delivery)]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <vaadin-grid-sorter path="order_status">
                                    <div class="cell">Status</div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell" style$="color:[[getColorStatus(item.order_status)]]">[[getOrderStatus(item.order_status)]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="50px">
                            <template class="header">
                                <div class="cell last">Edit</div>
                            </template>
                            <template>
                                <div class="cell last">
                                    <paper-icon-button on-tap="editOrder" order="[[item]]" icon="vaadin:pencil" title="Edit" disabled="[[isDeletable(item.order_status)]]"></paper-icon-button>
                                </div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="50px">
                            <template class="header">
                                <div class="cell numeric last">Cancel</div>
                            </template>
                            <template>
                                <div class="cell numeric last">
                                    <paper-icon-button on-tap="deleteOrder" order="[[item]]" icon="vaadin:close-small" title="Delete" disabled="[[isDeletable(item.order_status)]]"></paper-icon-button>
                                </div>
                            </template>
                        </vaadin-grid-column>

                    </vaadin-grid>
                    <div class="center">
                        <flat-button class="btn" on-tap="clearSchedule">
                            <button>Refresh (temp)</button>
                        </flat-button>
                        <flat-button class="btn thunderbird" on-tap="reSchedule">
                            <button>Reschedule</button>
                        </flat-button>
                    </div>
                </div>
            </li>
            <li>
                <div class="card">
                    <h1 class="title">{{localize('production-scheduling-table')}}</h1>
                    <p>Selected Station: [[selectedStation]]</p>
                    <p>{{localize('station-name')}}:
                        <template is="dom-repeat" items="[[selectedStationData]]" as="stationItem">[[stationItem.st_name]]</template>
                    </p>
                    <p>Station Machines:
                        <template is="dom-repeat" items="[[selectedStationData]]" as="item">
                            <template is="dom-repeat" items="[[item.st_machine]]" as="item">[[item.name]] </template>
                        </template>
                    </p>
                    <p>Machines quantity:
                        <template is="dom-repeat" items="[[selectedStationData]]" as="stationItem">[[stationItem.st_machine.length]]</template>
                    </p>
                    <vaadin-grid id="jobSchedulingTable" items="{{scheduleItems}}" page-size="20">
                        <vaadin-grid-column width="100px" flex="0">
                            <template class="header">
                                <div class="cell center">Station</div>
                            </template>
                            <template>
                                <div class="cell center">[[selectedStation]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Order No.</div>
                            </template>
                            <template>
                                <div class="cell">[[item.order_no]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <vaadin-grid-sorter path="order_status">
                                    <div class="cell">Color</div>
                                </vaadin-grid-sorter>
                            </template>
                            <template>
                                <div class="cell" style$="color:[[item.order_color]]">&#9608;</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="2">
                            <template class="header">
                                <div class="cell">Product</div>
                            </template>
                            <template>
                                <div class="cell">[[item.order_product]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <div class="cell">
                                    <span>Part</span>
                                </div>
                            </template>
                            <template>
                                <div class="cell">[[item.job_part]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column>
                            <template class="header">
                                <div class="cell">
                                    <span>Quantity</span>
                                </div>
                            </template>
                            <template>
                                <div class="cell">[[item.job_quantity]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Workload</div>
                            </template>
                            <template>
                                <div class="cell">[[item.job_workload]] mins.</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Est. Start</div>
                            </template>
                            <template>
                                <div class="cell">[[timestampToTime(item.start)]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Est. End</div>
                            </template>
                            <template>
                                <div class="cell">[[getEstEnd(item.start,item.job_workload)]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Used Machines</div>
                            </template>
                            <template>
                                <div class="cell">[[item.job_machine]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column flex="1">
                            <template class="header">
                                <div class="cell">Status</div>
                            </template>
                            <template>
                                <div class="cell" style$="color:[[getColorStatus(item.job_status)]]">[[getOrderStatus(item.job_status)]]</div>
                            </template>
                        </vaadin-grid-column>

                        <vaadin-grid-column width="100px" flex="0">
                            <template class="header">
                                <div class="cell numeric last">Cancel</div>
                            </template>
                            <template>
                                <div class="cell numeric last">
                                    <paper-icon-button on-tap="deleteJob" job="[[item]]" icon="vaadin:close-small" title="Delete" disabled="[[isDeletable(item.job_status)]]"></paper-icon-button>
                                </div>
                            </template>
                        </vaadin-grid-column>

                    </vaadin-grid>
                    <div class="center btn-group">
                        <iron-selector selected="{{selectedStation}}" attr-for-selected="name" fallback-selection="1" role="navigation">
                            <template is="dom-repeat" items="[[stationItems]]" as="stationItem">
                                <paper-button class="station-btn" name="[[stationItem.st_number]]">
                                    {{localize('station')}} [[stationItem.st_number]]
                                </paper-button>
                            </template>
                        </iron-selector>
                    </div>
                </div>
            </li>

            <li>
                <div class="card" id="chartContainer">
                    <h1 class="title">Scheduling Chart</h1>
                    <google-chart id="timeline" type="timeline" options="[[timelineOptions]]"></google-chart>
                </div>
            </li>
        </ul>
    </template>
    <script>
        /**
         * @ViewPlanScheduling
         * @polymer 
         * @extends {Polymer.Element}
         * @appliesMixin Polymer.AppLocalizeBehavior
         */
        class ViewPlanScheduling extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior, Polymer.IronResizableBehavior],
            Polymer.Element) {
            static get is() {
                return 'view-plan-scheduling'
            }

            static get properties() {
                return {
                    selectedStation: {
                        type: String,
                        reflectToAttribute: true,
                        value: 1
                    },
                    sortedOrder: {
                        type: Object,
                        notify: true
                    },
                    orderItems: {
                        type: Object,
                        observer: '_refreshOrderTable'
                    },
                    language: String,
                    status: String,
                    factoryPerformance: Object,
                    factoryOperation: Object,
                    factoryProfile: Object,
                    scheduleItems: Object,
                    timelineOptions: Object,
                    chartItems: Object,
                    width: Number,
                    height: Number
                }
            }

            static get observers() {
                return [
                    '_isSerialModel(factoryProfile.model)',
                    'getSortedOrder(orderItems)'
                ]
            }

            connectedCallback() {
                super.connectedCallback()
                this.loadResources(this.resolveUrl('../../data/locales.json'))
                requestAnimationFrame(this._installListeners.bind(this))
            }

            attributeChangedCallback() {
                super.attributeChangedCallback()
                this._refreshOrderTable()
            }

            _installListeners() {
                this.addEventListener('iron-resize', (e) => this._setChartSize(e))
            }

            _refreshOrderTable() {
                this.$.orderTable.clearCache();
            }

            _calculateWaitTime(machine, quantity) {
                machine = 106;
                quantity = 127;
                let cycle = 8;
                let setup = 10;
                let process = setup + (quantity * cycle);
                let temp = process; // temp = stores the initial workload and adds 1 cycle time IF there is not enough machines UNTIL there is enough
                if (machine < quantity) {
                    for (let i = 0; i < quantity; i += machine) {
                        temp += cycle;
                    }
                }
                let delay = temp - process;
                console.log("The total process time is: " + temp);
                console.log("The total delay is: " + delay);
            }

            refreshChart() {
                let data = [
                    ['1', 'Order 1', '#865551', new Date(2017, 10, 19, 8, 30, 0).getTime() / 1000, new Date(
                        2017, 10, 19, 8, 33, 0).getTime() / 1000],
                    ['1', 'Order 2', '#85DF4C', new Date(2017, 10, 19, 8, 30, 0).getTime() / 1000, new Date(
                        2017, 10, 19, 8, 38, 0).getTime() / 1000],
                    ['2', 'Order 1', '#865551', new Date(2017, 10, 19, 8, 33, 0).getTime() / 1000, new Date(
                        2017, 10, 19, 8, 45, 0).getTime() / 1000],
                    ['2', 'Order 2', '#85DF4C', new Date(2017, 10, 19, 8, 38, 0).getTime() / 1000, new Date(
                        2017, 10, 19, 8, 50, 0).getTime() / 1000],
                    ['3', 'Order 1', '#865551', new Date(2017, 10, 19, 8, 45, 0).getTime() / 1000, new Date(
                        2017, 10, 19, 9, 0, 36).getTime() / 1000],
                    ['3', 'Order 2', '#85DF4C', new Date(2017, 10, 19, 8, 50, 0).getTime() / 1000, new Date(
                        2017, 10, 19, 9, 14, 27).getTime() / 1000],
                    ['4', 'Order 1', '#865551', new Date(2017, 10, 19, 9, 0, 36).getTime() / 1000, new Date(
                        2017, 10, 19, 9, 30, 12).getTime() / 1000],
                    ['4', 'Order 1', '#85DF4C', new Date(2017, 10, 19, 9, 14, 27).getTime() / 1000, new Date(
                        2017, 10, 19, 10, 20, 12).getTime() / 1000]
                ]
                console.table(data)
                this.$.chartQuery.ref.set(data)
            }

            _serialSchedule() {
                let order = this.sortedOrder;
                if (order.length > 0) {

                } else {
                    alert("No order to reschedule")
                }
            }

            _parallelSchedule() {
                let order = this.sortedOrder;
                if (order.length > 0) {
                    // 1) Get concurrent and inital value
                    let concurrent = this.factoryProfile.concurrency;
                    let wip_order; // work in process order array
                    let wip_order_part = []
                    let wip_order_process = []
                    let order_quantity_wip = []

                    // 2) Copy first concurrent orders from sorted order table
                    let selected_order = order.slice(0, concurrent).concat(order.slice(order.length));
                    wip_order = selected_order // shift original order arr of concurrent and push to work in process order arr
                    console.table(wip_order)

                    // Print part dependency
                    for (let i in wip_order) {
                        console.table(wip_order[i].order_product_process)
                    }
                    wip_order_part = wip_order
                        .filter(o => o.order_status === 'waiting') // change this to waiting
                        .map(o => o.order_product_part)
                    console.table(wip_order_part)

                    wip_order_process = wip_order
                        .filter(o => o.order_status === 'waiting') // change this to waiting
                        .map(o => o.order_product_process)

                    // Machine in each station
                    let machine_in_station = this.stationItems.map(o => o.st_machine.length);
                    console.table(machine_in_station);

                    // 3. Calculate workload of each part
                    // 4. 

                    // for (let i in wip_order) {
                    //     let jobWorkload = wip_order.map((x) => x * order_quantity[i])
                    // }

                    // Group order by stations
                    const result = wip_order_part.reduce(function (r, a) {
                        r[a.process] = r[a.process] || [];
                        r[a.process].push(a);
                        return r;
                    }, Object.create(null));
                    // console.log(result);

                    // thos._addToSchedule(orderDate, orderNo, orderProduct, orderColor, jobPart, jobQuantity, jobMachine,
                    //jobStatus, jobStation, jobWorkload, startTime, endTime)
                } else {
                    alert("No order to reschedule")
                }
            }

            _multiSchedule() {
                let order = this.sortedOrder;
                if (order.length > 0) {} else {
                    alert("No order to reschedule")
                }
            }

            _isSerialModel(production_model) {
                if (production_model === 'serial') {
                    this.$.concurrency.hidden = true
                } else {
                    this.$.concurrency.hidden = false
                }
            }

            _addToSchedule(orderDate, orderNo, orderProduct, orderColor, jobPart, jobQuantity, jobMachine,
                jobStatus, jobStation, jobWorkload, startTime, endTime) {
                this.$.scheduleQuery.ref.push({
                    order_date: orderDate,
                    order_no: orderNo,
                    order_product: orderProduct,
                    order_color: orderColor,
                    job_part: jobPart,
                    job_quantity: jobQuantity,
                    job_machine: jobMachine,
                    job_workload: jobWorkload,
                    job_status: "waiting",
                    start: 1508962421,
                    end: 1508962421,
                })
            }

            getSortedOrder(order) {
                this.$.orderTable.clearCache();
                console.log('run sort order')
                // SORT BY EDD THEN BY SPT
                let sort = order.sort((a, b) => {
                    return a["order_delivery"] - b["order_delivery"] || a["order_duration"] - b[
                        "order_duration"];
                });
                this.sortedOrder = sort;
                return sort;
            }

            gcd(a, b) {
                return (b == 0) ? a : gcd(b, a % b);
            }

            _setChartSize() {
                this.width = this.$.chartContainer.offsetWidth;
                this.height = this.$.chartContainer.offsetHeight;
                if (this.width > 0) {
                    this.timelineOptions = {
                        width: this.width - 40,
                        height: this.height + 200,
                        timeline: {
                            showRowLabels: true,
                            rowLabelStyle: {
                                fontSize: 16
                            },
                            barLabelStyle: {
                                fontSize: 16
                            }
                        },
                        fontName: 'Roboto',
                        legend: {
                            position: 'none'
                        },
                        avoidOverlappingGridLines: false
                    }
                    google.charts.setOnLoadCallback(this._initialChart())
                    this.$.timeline.redraw()
                }
            }

            _initialChart() {
                let chart = this.$.timeline;
                let dataTable = new google.visualization.DataTable();
                dataTable.addColumn({
                    type: 'string',
                    id: 'Station'
                });
                dataTable.addColumn({
                    type: 'string',
                    id: 'Order no.'
                });
                dataTable.addColumn({
                    type: 'string',
                    role: 'style'
                });
                dataTable.addColumn({
                    type: 'date',
                    id: 'Start'
                });
                dataTable.addColumn({
                    type: 'date',
                    id: 'End'
                });
                if (this.chartItems.length > 0) {
                    // convert time stamp to new date 
                    const result = this.chartItems.map((x) => {
                        return [x[0], x[1], x[2],
                            new Date(x[3] * 1000),
                            new Date(x[4] * 1000)
                        ]
                    });
                    dataTable.addRows(result);
                } else {
                    dataTable.addRows([
                        ['\0', '\0', '#FFFFFF', new Date(1506470400), new Date(1506480400)]
                    ]);
                }
                document.createElement('google-chart-loader').dataTable(
                    dataTable).then((data) => {
                    chart.data = data;
                });
            }

            getNextInterval(last_timestamp, interval) {
                if (!last_timestamp || !interval) return 0
                let current = Math.floor(Date.now() / 1000)
                let diff = current - last_timestamp
                let range = interval * 24 * 60 * 60
                if (diff <= range) {
                    let nextIntervalStamp = (last_timestamp * 1000) + (interval * 24 * 60 * 60 *
                        1000)
                    let nextIntervalDate = new Date(nextIntervalStamp)
                    let dd = nextIntervalDate.getDate()
                    let mm = nextIntervalDate.getMonth() + 1 // January is 0!
                    let yyyy = nextIntervalDate.getFullYear()
                    if (dd < 10) {
                        dd = '0' + dd
                    }
                    if (mm < 10) {
                        mm = '0' + mm
                    }
                    let nextInterval = dd + '/' + mm + '/' + yyyy
                    return nextInterval
                } else {
                    this.set('factorySchedule.start_interval', current)
                }
            }

            getOrderDuration(order_duration) {
                if (!order_duration) return 0
                return this._minutesToStr(order_duration)
            }

            getRemainDay(delivery_date, status, key) {
                if (!delivery_date) return 0
                const current_date = Math.round(new Date().getTime() / 1000.0);
                const remain = Math.round((delivery_date - current_date) / 86400);

                if (remain < 0 && status !== 'done' && status !== 'wip') {
                    this.setLateOrder(key);
                    return 0;
                } else if (remain < 0 && (status === 'done' || status === 'wip' || status === 'late')) {
                    return 0;
                } else {
                    return remain;
                }
            }

            setLateOrder(key) {
                this.$.orderQuery.ref.child(key).update({
                    order_status: 'late'
                });
            }

            setNotification(detail, type) {
                const timestamp = Math.round(Date.now() / 1000.0);
                this.$.notificationQuery.ref.push({
                    created: timestamp,
                    detail: detail,
                    type: type
                });
            }

            getDeliveryDate(timestamp) {
                let today = new Date(timestamp * 1000);
                let dd = today.getDate();
                let mm = today.getMonth() + 1; //January is 0!
                let yyyy = today.getFullYear();
                if (dd < 10) {
                    dd = '0' + dd
                }
                if (mm < 10) {
                    mm = '0' + mm
                }
                let deliveryDate = dd + '/' + mm + '/' + yyyy;
                return deliveryDate;
            }

            getOrderStatus(order_status) {
                switch (order_status) {
                    case 'waiting':
                        return 'WAITING'
                        break;
                    case 'wip':
                        return 'WIP'
                        break;
                    case 'done':
                        return 'DONE'
                        break;
                    case 'late':
                        return 'LATED'
                        break;
                    case 'cancel':
                        return 'CANCELED'
                        break;
                    default:
                        return 'N/A'
                }
            }

            getColorStatus(order_status) {
                switch (order_status) {
                    case 'waiting':
                        return '#FFB300'
                        break;
                    case 'wip':
                        return '#5E35B1'
                        break;
                    case 'done':
                        return '#7CB342'
                        break;
                    case 'late':
                        return '#E53935'
                        break;
                    case 'cancel':
                        return '#E53935'
                        break;
                    default:
                        return '#202020'
                }
            }

            getEstEnd(start, workload) {
                let workload_second = workload * 60
                let end_timestamp = start + workload_second
                return this.timestampToTime(end_timestamp)
            }

            timestampToTime(timestamp) {
                let date = new Date((timestamp - 25200) * 1000);
                // Hours part from the timestamp
                let hours = date.getHours();
                // Minutes part from the timestamp
                let minutes = "0" + date.getMinutes();
                // Seconds part from the timestamp
                let seconds = "0" + date.getSeconds();
                // Will display time in 10:30:23 format
                let formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                return formattedTime;
            }

            clearSchedule() {
                this.$.orderTable.clearCache();
                // if (window.confirm(
                //         "Clear all schedule ? The order that are working in process will not be deleted."
                //     ) ==
                //     true) {
                //     this.$.orderQuery.ref.remove();
                // }
            }

            reSchedule() {
                //  window.alert('Note: Orders that are working in process will not able to reschedule.');
                switch (this.factoryProfile.model) {
                    case "serial":
                        this._serialSchedule()
                        break;
                    case "parallel":
                        this._parallelSchedule()
                        break;
                    case "multi":
                        this._multiSchedule()
                        break;
                    default:
                        window.alert("Invalid production model")
                }
            }

            // CONVERT TIME TO STRING
            _minutesToStr(minute) {
                let sign = '';
                if (minute < 0) {
                    sign = '0';
                }
                let hours = this._leftPad(Math.floor(Math.abs(minute) / 60));
                let minutes = this._leftPad(Math.round(Math.abs(minute) % 60));
                return sign + hours + 'hrs ' + minutes + 'min';
            }

            // ADD 0 to numbers less than 10,Eg: 2 -> 02 
            _leftPad(number) {
                return ((number < 10 && number >= 0) ? '0' : '') + number;
            }

            isDeletable(status) {
                return ((status === 'wip') ? true : false)
            }

            deleteOrder(e) {
                if (confirm("Delete this order ?")) {
                    let key = e.currentTarget.order.$key;
                    this.$.orderQuery.ref.child(key).remove();
                    this.$.orderTable.clearCache();
                }
            }

            deleteJob(e) {
                if (confirm("Delete this job ?")) {
                    let key = e.currentTarget.order.$key;
                    this.$.jobQuery.ref.child(key).remove();
                    window.alert("Delete job successfully");
                }
            }

        }
        customElements.define(ViewPlanScheduling.is, ViewPlanScheduling)
    </script>
</dom-module>