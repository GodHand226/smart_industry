<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../view-app.html">
<link rel="import" href="../style/shared-styles.html">
<link rel="import" href="../style/flat-button.html">

<dom-module id="view-track-production">
    <template>
        <style include="shared-styles app-grid-style flat-button">
             :host {
                display: block;
                margin: 10px;
                --app-grid-item-height: 50%;
            }

            @media (min-width: 360px) and (max-width: 768px) {
                 :host {
                    --app-grid-columns: 1;
                }
                .fixed-btn {
                    width: 100%;
                }
            }

            @media (min-width: 769px) and (max-width: 1024px) {
                 :host {
                    --app-grid-columns: 1;
                }
            }

            @media (min-width: 1025px) and (max-width: 1200px) {
                 :host {
                    --app-grid-columns: 2;
                }
            }

            @media (min-width: 1201px) and (max-width: 2560px) {
                 :host {
                    --app-grid-columns: 4;
                }
            }

            .flex-container {
                display: flex;
                align-content: center;
                justify-content: space-between;
                flex-flow: row nowrap;
            }

            .station-btn {
                margin: 5px;
                width: 200px;
            }

            .machine {
                margin: 10px;
                padding: 20px;
                border: 1px solid rgba(0, 0, 0, .10);
                border-radius: 3px;
            }

            .machine p {
                margin: 10px 0;
            }

            .machine h1 {
                text-align: center;
            }

            .machine-info-group {
                margin-bottom: auto;
            }

            .big-btn button {
                width: 400px;
                height: 100px;
                font-size: 2rem;
                display: block;
                font-size: 1.75rem;
                font-weight: 300;
            }

            .big-btn {
                margin: 10px 0 20px 0;
            }

            .main-card {
                margin-top: 26px;
            }

            p.machine-title {
                font-weight: 500;
            }
        </style>

        <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
        <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]" data="{{k}}"></firebase-document>
        <firebase-query app-name="smart-mes" id="scheduleQuery" path="/data/[[k.key]]/scheduleData" order-by-child="job_station"
            data="{{scheduleItems}}"></firebase-query>
        <firebase-query app-name="smart-mes" id="orderQuery" path="/data/[[k.key]]/orderData" order-by-child="order_no" data="{{orderItems}}"></firebase-query>
        <firebase-query app-name="smart-mes" id="warehouseQuery" path="/data/[[k.key]]/warehouseData" order-by-child="order_no" data="{{warehouseItems}}"></firebase-query>
        <firebase-query app-name="smart-mes" id="stationQuery" path="/data/[[k.key]]/factoryData/station" data="{{stationItems}}"></firebase-query>
        <firebase-query app-name="smart-mes" id="deviceQuery" path="/data/[[k.key]]/factoryData/device" data="{{deviceItems}}"></firebase-query>
        <app-localstorage-document key="app-lang" data="{{language}}"></app-localstorage-document>
        <div class="card main-card">
            <h1 class="title">Work In Progress Order Tracking</h1>
            <div class="center">
                <iron-selector selected="{{selectedStation}}" attr-for-selected="name" fallback-selection="1" role="navigation">
                    <template is="dom-repeat" items="[[stationItems]]" as="stationItem">
                        <paper-button class="station-btn" name="[[stationItem.st_number]]">
                            {{localize('station')}} [[stationItem.st_number]]
                        </paper-button>
                    </template>
                </iron-selector>
            </div>
            <ul class="app-grid">
                <template is="dom-repeat" filter="{{filterByStation(selectedStation)}}" observe="job_station" items="{{scheduleItems}}" as="item">
                    <li>
                        <div class="machine">
                            <div class="machine-info-group">
                                <h2 class="title">{{localize('part')}} [[item.job_part]]</h2>
                                <p>{{localize('quantity')}}: [[item.job_quantity]] {{localize('item')}} </p>
                                <p>{{localize('product-part')}}: [[item.order_product]]</p>
                                <p style$="color:[[item.order_color]]">{{localize('order-number')}}: [[item.order_no]]</p>
                                <p>{{localize('workload')}}: [[item.job_workload]]</p>
                                <p>{{localize('station')}}: [[item.job_station]]</p>
                                <p>{{localize('est-start')}}: [[timestampUTCToTime(item.start)]]</p>
                                <p>{{localize('est-end')}}: [[timestampUTCToTime(item.end)]]</p>
                                <p>{{localize('actual-start')}}: [[timestampToTime(item.actual_start)]]</p>
                                <p>{{localize('actual-end')}}: [[timestampToTime(item.actual_end)]]</p>
                                <p>{{localize('duration')}}: [[getActualDuration(item.actual_start,item.actual_end)]]</p>
                                <p>{{localize('defect')}}: [[item.job_defect]] {{localize('item')}} </p>
                                <p>Job good: [[item.job_good]] {{localize('item')}} </p>
                                <p>Productivity rate: 0 {{localize('item')}} / {{localize('hour')}}</p>
                                <p>{{localize('done')}}: [[item.job_good]] / [[item.job_quantity]]</p>
                                <p>{{localize('status')}}:
                                    <span class$="[[getTextStatus(item.job_status)]]" style$="color:[[getColorStatus(item.job_status)]]">[[item.job_status]]</span>
                                </p>
                            </div>
                            <flat-button class="btn" on-tap="receiveJob" job="[[item]]">
                                <button>Receive</button>
                            </flat-button>
                            <flat-button class="btn shamrock" on-tap="finishJob" job="[[item]]">
                                <button disabled="[[isDone(item.job_status)]]">Finish</button>
                            </flat-button>
                            <flat-button class="thunderbird btn" on-tap="removeJob" job="[[item]]">
                                <button>{{localize('remove')}}</button>
                            </flat-button>
                        </div>
                    </li>
                </template>
                <h1 class="center" hidden$="[[isEmptyJobs(scheduleItems.length)]]">No job schedule found</h1>
            </ul>
        </div>
        <div class="card main-card">
            <h1 class="title">Tracking Device Management</h1>
            <ul class="app-grid">
                <template is="dom-repeat" items="{{deviceItems}}" as="device">
                    <li>
                        <div class="machine">
                            <div class="machine-info-group">
                                <h2 class="title">[[device.name]]</h2>
                                <p>{{localize('type')}}: [[device.type]]</p>
                                <p>{{localize('machine-number')}}: [[device.machine]]</p>
                                <p>Count: [[device.counter]]</p>
                                <p>{{localize('order-number')}}: [[device.order_no]]</p>
                                <p>Updated: [[timestampToTime(device.update)]]</p>
                            </div>
                            <paper-toggle-button class="switch" checked="{{device.enable}}" id="deviceControlSwitch" noink> Enabled</paper-toggle-button>
                            <flat-button class="btn" on-tap="resetCounter" device="[[device]]">
                                <button>Reset Counter</button>
                            </flat-button>
                            <flat-button class="btn" on-tap="_openEditMachineCard" device="[[device]]">
                                <button>{{localize('edit')}}</button>
                            </flat-button>
                            <flat-button class="thunderbird btn" on-tap="removeDevice" device="[[device]]">
                                <button>{{localize('remove')}}</button>
                            </flat-button>
                        </div>
                    </li>
                </template>
            </ul>
            <div class="center">
                <flat-button class="big-btn" on-tap="openAddDeviceCard">
                    <button>Add Device</button>
                </flat-button>
            </div>
        </div>
        <vaadin-dialog id="reportFinishDialog" class="dialog">
            <template>
                <custom-style>
                    <style is="custom-style" include="view-settings">
                         :host {
                            max-width: 500px;
                            margin-top: 100px;
                            --app-background-color: transpalent;
                            --paper-input-container-focus-color: var( --app-primary-color);
                        }

                        [part="content"] {
                            padding: 20px 30px;
                        }

                        h1 {
                            margin: 10px 0 20px 0;
                        }

                        .center {
                            text-align: center;
                        }

                        .btn-group {
                            margin: 10px 0 0 0;
                            display: flex;
                            text-align: center;
                        }

                        .btn {
                            margin: 0 10px 0px 10px;
                        }
                    </style>
                </custom-style>
                <h1 class="center">Done Report</h1>
                <paper-input label="Defect" id="defectCount" value="{{defect}}" type="number" always-float-label></paper-input>
                <div class="btn-group">
                    <paper-button dialog-dismiss on-tap="closeFinishDialog">
                        {{localize('dismiss')}}
                    </paper-button>
                    <paper-button dialog-confirm autofocus on-tap="updateFinish">
                        {{localize('save')}}
                    </paper-button>
                </div>
            </template>
        </vaadin-dialog>
    </template>
    <script>
        /**
         * @ViewTrackProduction
         * @polymer 
         * @extends {Polymer.Element}
         * @appliesMixin Polymer.AppLocalizeBehavior
         */
        class ViewTrackProduction extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior],
            Polymer.Element) {
            static get is() {
                return 'view-track-production';
            }

            static get properties() {
                return {
                    selectedStation: {
                        type: String,
                        reflectToAttribute: true,
                        value: 1
                    },
                    language: String,
                    orderHistoryData: Object,
                    orderItems: Object,
                    scheduleItems: Object,
                    warehouseItems: Object,
                    defect: {
                        type: Number,
                        value: 0
                    }
                }
            }

            connectedCallback() {
                super.connectedCallback();
                this.loadResources(this.resolveUrl('../../data/locales.json'));
            }

            removeJob(e) {
                if (window.confirm("Remove this job?") == true) {
                    const key = e.currentTarget.job.$key;
                    this.$.scheduleQuery.ref.child(key).remove();
                }
            }

            finishJob(e) {
                this.openFinishDialog(e);
            }

            openFinishDialog(e) {
                this.$.reportFinishDialog.opened = true;
                this.selectedJob = e.currentTarget.job;
            }

            closeFinishDialog() {
                this.$.reportFinishDialog.opened = false;
            }

            receiveJob(e) {
                console.log(e.currentTarget.job.order_no);
                this.$.scheduleQuery.ref.child(e.currentTarget.job.$key).update({
                    actual_start: Math.round(new Date().getTime() / 1000.0),
                    job_status: 'wip'
                })
            }

            updateFinish(e) {
                if (!this.defect) this.defect = 0;
                if (this.defect < this.selectedJob.job_quantity) {
                    this.$.scheduleQuery.ref.child(this.selectedJob.$key).update({
                        actual_end: Math.round(new Date().getTime() / 1000.0),
                        job_status: 'done',
                        job_defect: this.defect,
                        job_good: (this.selectedJob.job_quantity - this.defect) // output of station
                    })
                    this.$.reportFinishDialog.opened = false;
                    this.selectedJob = '';
                    this._checkJobStatus()
                }
            }

            getActualDuration(start, end) {
                if (start && end) {
                    const diff = end - start;
                    return this.secondsToHms(diff);
                }
                return 0
            }

            isEmptyJobs(length) {
                if (length === 0) {
                    return false;
                } else {
                    return true;
                }
            }

            filterByStation(station) {
                if (!station) {
                    // set filter to null to disable filtering
                    return null;
                } else {
                    let filterData = ((scheduleItems) => {
                        return scheduleItems.job_station == station
                    });
                    return filterData;
                }
            }

            _checkJobStatus() {
                if (!this.scheduleItems) return
                // 1) group by order_no as an array
                let order_group = this.scheduleItems.reduce((r, a) => {
                    r[a.order_no] = r[a.order_no] || [];
                    r[a.order_no].push(a);
                    return r;
                }, new Array());
                // 2) condition to filter order_status == done
                let isDone = ((element, index, array) => {
                    if (element.job_status === 'done') {
                        return true;
                    }
                })
                // 3) check that element job_status of every item is == done
                let done_order = [];
                if (order_group.length > 0) {
                    let i = 1;
                    while (i < order_group.length) {
                        if (order_group[i].every(isDone)) {
                            done_order.push(order_group[i]);
                        }
                        i++
                    }
                }
                // 4) if every jobs in order is done so push to done_order 
                if (done_order.length > 0) {
                    let warehouse_order;
                    for (let i = 0; i < done_order.length; i++) {
                        warehouse_order = done_order[i].map((value, index, arr) => {
                            return {
                                order_product: value.order_product,
                                order_color: value.order_color,
                                order_good: value.job_good,
                                order_quantity: value.job_quantity,
                                order_no: value.order_no,
                                order_defect: parseInt(value.job_defect),
                                job_station: value.job_station,
                                // order_defect: done_order[i].reduce((a, o) => {
                                //     return a + o.job_defect
                                // }, 0),
                                plan_duration: (value.end - value.start),
                                actual_duration: (value.actual_end - value.actual_start),
                            };
                        });
                    }
                    console.table(warehouse_order);
                    this.addToWarehouse(warehouse_order);
                    let groupOrder = this.groupByKey(warehouse_order, x => x.order_no);

                    console.table(grouped.get("1"));
                    let doneOrderNo = warehouse_order.map(o => o.order_no);
                    console.log(doneOrderNo)
                    // for (let j = 0; j < doneOrderNo.length; j++) {
                    //      this.updateOrderTable(doneOrderNo[j]);
                    // }

                }
            }

            groupByKey(list, keyGetter) {
                const map = new Map();
                list.forEach((item) => {
                    const key = keyGetter(item);
                    const collection = map.get(key);
                    if (!collection) {
                        map.set(key, [item]);
                    } else {
                        collection.push(item);
                    }
                });
                return map;
            }

            updateOrderTable(orderNo) {
                if (orderNo) {
                    const query = this.$.orderQuery.ref;
                    query.orderByChild("order_no").equalTo(orderNo).once("child_added", ((snapshot) => {
                        snapshot.ref.update({
                            order_status: "done"
                        })
                    }))
                }
            }

            addToWarehouse(data) {
                if (data) {
                    delete data.warehouse_order
                    console.log(data)
                    this.$.warehouseQuery.ref.push(data);
                }
            }

            secondsToHms(sec) {
                sec = Number(sec);
                const h = Math.floor(sec / 3600);
                const m = Math.floor(sec % 3600 / 60);
                const s = Math.floor(sec % 3600 % 60);
                return ('0' + h).slice(-2) + ":" + ('0' + m).slice(-2) + ":" + ('0' + s).slice(-2);
            }

            timestampUTCToTime(timestamp) {
                const date = new Date((timestamp - 25200) * 1000);
                const hours = date.getHours();
                const minutes = "0" + date.getMinutes();
                const seconds = "0" + date.getSeconds();
                const formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                return formattedTime;
            }

            timestampToTime(timestamp) {
                const date = new Date((timestamp) * 1000);
                const hours = date.getHours();
                const minutes = "0" + date.getMinutes();
                const seconds = "0" + date.getSeconds();
                const formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                return formattedTime;
            }

            resetCounter(e) {
                const key = e.currentTarget.device.$key;
                this.$.deviceQuery.ref.child(key).update({
                    counter: 0
                })
            }

            isDone(status) {
                if (status === 'done') {
                    return true;
                }
                return false;
            }

            getColorStatus(job_status) {
                switch (job_status) {
                    case 'waiting':
                        return '#FFB300'
                        break;
                    case 'wip':
                        return '#5E35B1'
                        break;
                    case 'done':
                        return '#7CB342'
                        break;
                    case 'late':
                        return '#E53935'
                        break;
                    case 'cancel':
                        return '#E53935'
                        break;
                    default:
                        return '#202020'
                }
            }

            getTextStatus(job_status) {
                switch (job_status) {
                    case 'waiting':
                        return 'normal'
                        break;
                    case 'wip':
                        return 'blink'
                        break;
                    case 'done':
                        return 'normal'
                        break;
                    case 'late':
                        return 'normal'
                        break;
                    case 'cancel':
                        return 'normal'
                        break;
                    default:
                        return 'normal'
                }
            }
            // Device management
            removeDevice(e) {
                if (window.confirm("Remove this device?") == true) {
                    const key = e.currentTarget.device.$key;
                    this.$.deviceQuery.ref.child(key).remove();
                }
            }

            openAddDeviceCard() {

            }
        }
        customElements.define(ViewTrackProduction.is, ViewTrackProduction);
    </script>
</dom-module>