<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../view-app.html">
<link rel="import" href="../style/shared-styles.html">
<link rel="import" href="../style/flat-button.html">

<dom-module id="view-dashboard-statistic">
  <template>
    <style include="shared-styles app-grid-style flat-button">
       :host {
        margin: 10px;
        display: block;
        --app-grid-columns: 1;
        --app-grid-item-height: 50%;
      }

      .btn {
        margin: 20px 0 4px 0;
        width: 250px;
      }

      google-chart {
        height: 100%;
        width: 100%;
      }

      @media (min-width: 360px) and (max-width: 768px) {
        #column {
          width: 100%;
        }
      }
    </style>
    <firebase-auth app-name="smart-mes" id="auth" user="{{user}}"></firebase-auth>
    <firebase-document app-name="smart-mes" id="userData" path="/user/[[user.uid]]" data="{{k}}"></firebase-document>
    <firebase-document app-name="smart-mes" id="historyQuery" path="/data/[[k.key]]/historyData" data="{{historyData}}"></firebase-document>
    <app-localstorage-document key="app-lang" data="{{language}}"></app-localstorage-document>
    <ul class="app-grid">
      <li>
        <div class="card" id="chartContainer">

          <h1 class="title">Product Order Statistic</h1>
          <google-chart id="column" type="column" options="[[columnOptions]]" cols='[[columnItems]]' rows='[[rowItems]]'></google-chart>

          <flat-button class="btn" on-tap="clearStatistic">
            <button>Reset Statistic</button>
          </flat-button>
        </div>
      </li>
    </ul>
    <paper-toast id="toastAlert" always-on-top horizontal-align="right" text="{{localize(toastText)}}"></paper-toast>
  </template>
  <script>
    /**
     * @ViewDashboardStatistic
     * @polymer 
     * @extends {Polymer.Element}
     * @appliesMixin Polymer.AppLocalizeBehavior
     */
    class ViewDashboardStatistic extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior, Polymer.IronResizableBehavior],
      Polymer.Element) {
      static get is() {
        return 'view-dashboard-statistic';
      }

      static get properties() {
        return {
          language: String,
          historyData: Object,
          columnOptions: Object,
          width: Number,
          height: Number,
          rowItems: Array,
          toastText: String,
          columnItems: {
            type: Array,
            value: () => {
              return [{
                "label": "Data",
                "type": "string"
              }, {
                "label": "Value",
                "type": "number"
              }]

            }
          }
        }
      }

      connectedCallback() {
        super.connectedCallback();
        this.loadResources(this.resolveUrl('../../data/locales.json'));
        requestAnimationFrame(this._installListeners.bind(this))
      }

      _installListeners() {
        // listen for custom events on main page
        this.addEventListener('iron-resize', (e) => this._setChartSize(e))
      }

      _setChartSize() {
        this.width = this.$.chartContainer.offsetWidth;
        this.height = this.$.chartContainer.offsetHeight;
        if (this.width > 0) {
          this.columnOptions = {
            width: this.width,
            height: this.height,
            vAxis: {
              "minValue": 0,
              "maxValue": 10
            },
            tooltip: {
              isHtml: true
            }
          }
          if (this.historyData) {
            this._groupByProp(this.historyData.order)
          }
          this.$.column.redraw()
        }
      }

      _groupByProp(obj) {
        // convert obj to arr
        let arr = Object.keys(obj).map(k => obj[k]);
        // group by product name
        let data = arr.reduce((group, item, index, array) => {
          group[item.order_product] = parseInt(group + item.order_quantity)
          //array.reduce((total, obj) => {
          //   return total + obj.order_quantity
          // }, 0)
          //
          return group
        }, [])

        // convert into sub array
        this.rowItems = Object.entries(data);

        // THis will sum all order quantity
        let x = arr.reduce((total, obj) => {
          return total + obj.order_quantity
        }, 0)
        console.log(x)
      }

      clearStatistic() {
        if (confirm("Are you sure do you want to clear product order history ?") == true) {
          this.$.orderHistoryQuery.ref.child('order').remove()
          this.toastText = "notification-delete-successfully"
          this.$.toastAlert.open()
        }
      }
    }
    customElements.define(ViewDashboardStatistic.is, ViewDashboardStatistic);
  </script>
</dom-module>